<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØµØ© Ù„ØºØªÙŠ Ù‡ÙˆÙŠØªÙŠ - Ø§Ù„Ù…Ø·ÙˆØ±</title>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --main: #4a90e2; --sec: #2ecc71; --vocab: #9b59b6;
            --video: #e67e22; --err: #e74c3c; --bg: #f4f7f6;
            --white: #ffffff; --text: #2d3436;
        }
        * { box-sizing: border-box; transition: 0.3s; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 20px; min-height: 100vh; }

        .container {
            width: 100%; max-width: 1000px; background: var(--white);
            border-radius: 30px; padding: 30px; margin: 0 auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        h2, h3 { color: var(--main); font-weight: 900; margin-top: 0; }

        input, select, textarea {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 1px solid #cbd5e1; border-radius: 12px;
            font-size: 15px; outline: none; display: block;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--main); }

        .btn { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; margin-bottom: 10px; color: white; font-size: 16px; display: inline-flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-main { background: var(--main); }
        .btn-sec { background: var(--sec); }
        .btn-video { background: var(--video); }
        .btn-del { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; width: auto; padding: 5px 10px; font-size: 12px; border-radius: 5px; cursor: pointer; }
        .btn-edit { background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; width: auto; padding: 5px 10px; font-size: 12px; margin-left: 5px; border-radius: 5px; cursor: pointer; }
        .btn-report { background: #e0e7ff; color: #4338ca; border: 1px solid #c7d2fe; width: auto; padding: 5px 10px; font-size: 12px; margin-left: 5px; border-radius: 5px; cursor: pointer; }
        .btn-outline { background: #fff; border: 2px solid #e2e8f0; color: #64748b; }

        .admin-nav { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .admin-nav button { flex: 1; min-width: 120px; font-size: 14px; margin: 0; border-radius: 20px; }
        .admin-tab { display: none; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        #login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background: #f1f5f9; color: var(--main); white-space: nowrap; }

        .btn-small-danger {
            background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5;
            font-size: 11px; padding: 4px 8px; border-radius: 6px;
            width: auto; display: inline-block; cursor: pointer; float: left;
        }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20000; justify-content: center; align-items: center; padding: 15px; }
        .modal-content { background: white; width: 100%; max-width: 600px; border-radius: 20px; padding: 25px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-close { position: absolute; left: 20px; top: 20px; font-size: 25px; cursor: pointer; color: #aaa; }

        #global-loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 30000; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #eee; border-top-color: var(--main); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to {transform: rotate(360deg);} }

        .manage-filter-bar { display: flex; gap: 5px; margin-bottom: 10px; }
        .manage-filter-btn { padding: 5px 15px; border-radius: 15px; border: 1px solid #eee; background: white; cursor: pointer; font-size: 13px; }
        .manage-filter-btn.active { background: var(--main); color: white; border-color: var(--main); }

        /* Ù…Ø±Ø¨Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù„Ù„Ø¯Ù…Ø¬ */
        .check-exam-box { padding: 10px; border: 1px solid #eee; margin-bottom: 5px; border-radius: 8px; display: flex; align-items: center; gap: 10px; background: #fff; }
        .check-exam-box:hover { background: #f9f9f9; }
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨ */
        .report-header { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .report-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-box { background: #f8fafc; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #e2e8f0; }
        .stat-box h4 { margin: 0; color: #64748b; font-size: 12px; }
        .stat-box p { margin: 5px 0 0; font-weight: 900; font-size: 20px; color: var(--main); }
        .level-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; color: white; font-weight: bold; font-size: 14px; margin-top: 5px; }
        .level-excellent { background: #2ecc71; }
        .level-good { background: #f1c40f; }
        .level-weak { background: #e74c3c; }
    </style>
</head>
<body>
    <div id="global-loader"> <div class="spinner"></div> </div>

    <div id="login-overlay">
        <div id="login-box">
            <img src="https://cdn-icons-png.flaticon.com/512/3426/3426653.png" width="80" style="margin-bottom:20px;">
            <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            <input type="email" id="adm-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="adm-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn btn-main" onclick="adminLogin()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div class="container" id="admin-panel" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø·ÙˆØ± âš™ï¸</h2>
            <a href="index.html" target="_blank" class="btn btn-outline" style="width: auto; padding: 8px 15px;">Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø·Ø§Ù„Ø¨ <i class="fas fa-external-link-alt"></i></a>
        </div>

        <div class="admin-nav">
            <button class="btn btn-main" onclick="showTab('tab-create-exam')">ğŸ“ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø¯Ù…Ø¬</button>
            <button class="btn btn-main" onclick="showTab('tab-q')">â• Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø©</button>
            <button class="btn btn-sec" onclick="showTab('tab-l')">ğŸ“š Ø§Ù„Ø¯Ø±ÙˆØ³</button>
            <button class="btn btn-video" onclick="showTab('tab-v')">ğŸ¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</button>
            <button class="btn btn-outline" onclick="showTab('tab-posts'); loadExamsForPosts();" style="border-color:#e67e22; color:#e67e22;">ğŸ“¢ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</button>
            <button class="btn btn-outline" onclick="showTab('tab-mng'); loadManageData('all');">ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰</button>
            <button class="btn btn-outline" onclick="showTab('tab-users'); loadStudents();" style="border-color:#8b5cf6; color:#8b5cf6;">ğŸ‘¥ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
            <button class="btn btn-outline" onclick="showTab('tab-rules'); loadBadgeRules();" style="border-color:#f59e0b; color:#f59e0b;">ğŸ… Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</button>
            <button class="btn btn-outline" onclick="showTab('tab-results'); loadStudentResults();" style="border-color:var(--sec); color:var(--sec);">ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
            <button class="btn btn-outline" onclick="showTab('tab-settings')" style="border-color:#4a90e2; color:#4a90e2;">ğŸ› ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button class="btn btn-outline" onclick="adminLogout()" style="border-color:#e74c3c; color:#e74c3c; flex: 0;">Ø®Ø±ÙˆØ¬</button>
        </div>

        <div id="tab-create-exam" class="admin-tab" style="display: block;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3>ğŸŒŸ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù…ØªØ­Ø§Ù† Ø¬Ø¯ÙŠØ¯</h3>
                    <div style="background:#f0f9ff; padding:15px; border-radius:15px; border:1px solid #bae6fd;">
                        <input id="exam-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†">
                        <div style="display:flex; gap:10px;">
                            <select id="exam-grade">
                                <option value="all">Ø§Ù„Ø¬Ù…ÙŠØ¹ (ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„)</option>
                                <option value="4">4 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="5">5 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="6">6 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                <option value="7">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="8">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="9">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                            </select>
                            <select id="exam-subject">
                                <option value="grammar">Ù†Ø­Ùˆ</option>
                                <option value="vocab">Ù…ÙØ±Ø¯Ø§Øª</option>
                            </select>
                        </div>
                        <select id="exam-category">
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ (Ø§Ù„Ù…Ø¬Ù„Ø¯) --</option>
                            <option value="Ø£Ø³Ø¨ÙˆØ¹ÙŠ">ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</option>
                            <option value="Ø´Ø§Ù…Ù„">Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø´Ø§Ù…Ù„Ø©</option>
                            <option value="ØªØ±Ù…1">ØªØ±Ù… Ø£ÙˆÙ„</option>
                            <option value="ØªØ±Ù…2">ØªØ±Ù… Ø«Ø§Ù†ÙŠ</option>
                            <option value="Ø£ÙƒØªÙˆØ¨Ø±">Ø£ÙƒØªÙˆØ¨Ø±</option>
                            <option value="Ù†ÙˆÙÙ…Ø¨Ø±">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                            <option value="Ø¯ÙŠØ³Ù…Ø¨Ø±">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                            <option value="ÙØ¨Ø±Ø§ÙŠØ±">ÙØ¨Ø±Ø§ÙŠØ±</option>
                            <option value="Ù…Ø§Ø±Ø³">Ù…Ø§Ø±Ø³</option>
                            <option value="Ø£Ø¨Ø±ÙŠÙ„">Ø£Ø¨Ø±ÙŠÙ„</option>
                        </select>
                        <button class="btn btn-main" onclick="createExam()">Ø­ÙØ¸ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                </div>

                <div>
                    <h3>ğŸ”„ Ø¯Ù…Ø¬ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª (Ù†Ø³Ø® Ø§Ù„Ø£Ø³Ø¦Ù„Ø©)</h3>
                    <div style="background:#fff7ed; padding:15px; border-radius:15px; border:1px solid #fed7aa;">
                        <label>1. Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¯Ù…Ø¬Ù‡Ø§:</label>
                        <div id="merge-source-list" style="height: 150px; overflow-y: auto; background: white; border: 1px solid #ddd; border-radius: 8px; padding: 5px; margin-bottom: 10px;">
                            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                        </div>
                        <label>2. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù…Ø¯Ù…Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
                        <input id="merge-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                        <select id="merge-grade">
                            <option value="all">Ø§Ù„Ø¬Ù…ÙŠØ¹ (ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„)</option>
                            <option value="4">4 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="5">5 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="6">6 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                            <option value="7">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="8">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="9">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        </select>
                         <select id="merge-category">
                            <option value="Ø´Ø§Ù…Ù„">Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø´Ø§Ù…Ù„Ø©</option>
                            <option value="ØªØ±Ù…1">ØªØ±Ù… Ø£ÙˆÙ„</option>
                            <option value="ØªØ±Ù…2">ØªØ±Ù… Ø«Ø§Ù†ÙŠ</option>
                            <option value="Ø£Ø³Ø¨ÙˆØ¹ÙŠ">ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</option>
                        </select>
                        <button class="btn btn-video" onclick="mergeExams()">Ø¯Ù…Ø¬ ÙˆØ¥Ù†Ø´Ø§Ø¡</button>
                    </div>
                </div>
            </div>

            <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h3>
            <div id="exams-list"></div>
        </div>

        <div id="tab-q" class="admin-tab">
            <h3>Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ø­Ø¯Ø¯</h3>
            <div style="background:#fff; padding:15px; border-radius:15px; border:1px solid #eee;">
                <label style="color:red; font-weight:bold;">1. Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø°ÙŠ Ø³ØªØ¶ÙŠÙ ÙÙŠÙ‡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
                <select id="target-exam-select" onchange="loadExamQuestionsCount()">
                    <option value="">-- Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„... --</option>
                </select>
                <div id="exam-q-info" style="color:green; font-weight:bold; margin-bottom:10px;"></div>
            </div>
            
            <div class="bulk-area" style="margin-top:15px;">
                <b>ğŸš€ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø¬Ù…Ø¹ (JSON) Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:</b>
                <textarea id="in-bulk" rows="4" placeholder="[{&quot;q&quot;:&quot;Ø³Ø¤Ø§Ù„&quot;,&quot;c&quot;:&quot;ØµØ­&quot;,&quot;w&quot;:[&quot;Ø®Ø·Ø£1&quot;,&quot;Ø®Ø·Ø£2&quot;]}]"></textarea>
                <button class="btn btn-main" onclick="addBulkQuestions()">Ø±ÙØ¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù…Ø®ØªØ§Ø±</button>
            </div>
            
            <div style="margin-top:15px; border-top:1px solid #ddd; padding-top:10px;">
                <b>Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯:</b>
                <input id="q-text" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„">
                <input id="q-c" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©">
                <input id="q-w1" placeholder="Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© 1">
                <input id="q-w2" placeholder="Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© 2">
                <button class="btn btn-sec" onclick="addQuestionToExam()">Ø­ÙØ¸ Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯</button>
            </div>
        </div>

        <div id="tab-l" class="admin-tab">
            <h3>Ù†Ø´Ø± Ø¯Ø±Ø³</h3>
            <select id="in-l-grade">
                <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option>
                <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                <option value="7">7</option><option value="8">8</option><option value="9">9</option>
            </select>
            <input id="in-l-tit" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³">
            <textarea id="in-l-bod" rows="6" placeholder="Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø´Ø±Ø­..."></textarea>
            <input id="in-l-img" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            <button class="btn btn-sec" onclick="saveLesson()">Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³</button>
        </div>

        <div id="tab-v" class="admin-tab">
            <h3>Ù†Ø´Ø± ÙÙŠØ¯ÙŠÙˆ</h3>
            <select id="in-v-grade">
                <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option>
                <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                <option value="7">7</option><option value="8">8</option><option value="9">9</option>
            </select>
            <input id="v-tit" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ">
            <input id="v-url" placeholder="Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ Ø£Ùˆ ØªÙŠÙƒ ØªÙˆÙƒ">
            <button class="btn btn-video" onclick="saveVideo()">Ù†Ø´Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
        </div>

        <div id="tab-posts" class="admin-tab">
            <h3>ğŸ“¢ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ± / Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯</h3>
            <div style="background:#fdf2f8; padding:20px; border-radius:15px; border:1px solid #fbcfe8;">
                <input id="post-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ± / Ø§Ù„Ø®Ø¨Ø±">
                <textarea id="post-body" rows="3" placeholder="Ù†Øµ Ø§Ù„Ù…Ù†Ø´ÙˆØ±..."></textarea>
                <input id="post-img" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ù„Ù„Ù…Ù†Ø´ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                
                <label>Ø¥Ø±ÙØ§Ù‚ Ø§Ù…ØªØ­Ø§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                <select id="post-exam-select">
                    <option value="">-- Ø¨Ø¯ÙˆÙ† Ø§Ù…ØªØ­Ø§Ù† --</option>
                </select>

                <label>ÙŠØ¸Ù‡Ø± Ù„Ù…ÙŠÙ†ØŸ</label>
                <select id="post-grade">
                    <option value="all">Ù„Ù„Ø¬Ù…ÙŠØ¹ (Ø¹Ø§Ù…)</option>
                    <option value="4">4 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="5">5 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="6">6 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="7">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="8">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="9">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                </select>

                <button class="btn btn-main" onclick="createPost()">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
            </div>
            <hr>
            <h4>Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h4>
            <div id="posts-list-manage"></div>
        </div>

        <div id="tab-mng" class="admin-tab">
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù)</h3>
            <div class="manage-filter-bar">
                <button class="manage-filter-btn active" onclick="loadManageData('all', this)">Ø§Ù„ÙƒÙ„</button>
                <button class="manage-filter-btn" onclick="loadManageData('questions', this)">Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
                <button class="manage-filter-btn" onclick="loadManageData('lessons', this)">Ø§Ù„Ø¯Ø±ÙˆØ³</button>
                <button class="manage-filter-btn" onclick="loadManageData('videos', this)">Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</button>
            </div>
            <div id="mng-list" style="max-height:450px; overflow-y:auto; background:white; padding:10px; border-radius:10px; border:1px solid #ddd;"></div>
        </div>

        <div id="tab-users" class="admin-tab">
            <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ + Ø­Ø°Ù)</h3>
            <div style="overflow-x:auto;">
                <table class="results-table">
                    <thead> <tr> <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th> <th>Ø§Ù„ØµÙ</th> <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th> <th style="min-width: 250px;">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th> </tr> </thead>
                    <tbody id="users-body"><tr><td colspan="4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="tab-rules" class="admin-tab">
            <h3>Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</h3>
            <div style="background:#fffbe6; padding:10px; margin-bottom:10px; border:1px solid #ffe58f;">
                <input id="badge-title" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø© (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨)">
                <input id="badge-icon" placeholder="ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (fas fa-star)">
                <select id="badge-cond"><option value="exams_count">Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</option><option value="perfect_score">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</option></select>
                <input id="badge-thresh" type="number" placeholder="Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ù…Ø«Ù„Ø§Ù‹ 5)">
                <button class="btn btn-main" onclick="createRule()">Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø¯Ø©</button>
            </div>
            <div id="rules-list"></div>
        </div>

        <div id="tab-results" class="admin-tab">
            <h3>Ø³Ø¬Ù„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø§Ù„ÙƒÙ„) ğŸ†</h3>
            <button class="btn-small-danger" onclick="clearResults()"><i class="fas fa-trash"></i> Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
            <div style="clear:both; height:10px;"></div>
            <div style="overflow-x:auto;">
                <table class="results-table">
                    <thead> <tr> <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th> <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th> <th>Ø§Ù„ØµÙ</th> <th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th> <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th> <th>Ø­Ø°Ù</th> </tr> </thead>
                    <tbody id="results-body"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-settings" class="admin-tab">
            <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ø© ğŸ› ï¸</h3>
            <div style="background:#f0f7ff; padding:15px; border-radius:15px; border:1px solid #4a90e2; margin-bottom:15px;">
                <b>ğŸ“ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</b>
                <input type="text" id="set-title" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØµØ©">
                <input type="text" id="set-logo" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø±">
                <textarea id="set-desc" rows="4" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØµØ©..."></textarea>
            </div>
             <div style="background:#fff0f6; padding:15px; border-radius:15px; border:1px solid #f472b6; margin-bottom:15px;">
                <b>ğŸ“± ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„:</b>
                <input type="text" id="set-app-url" placeholder="Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Direct Link / Play Store)">
                <small style="color:#666;">Ø³ÙŠØ¸Ù‡Ø± Ø²Ø± "Ø­Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø·Ø§Ù„Ø¨ Ø¥Ø°Ø§ ÙˆØ¶Ø¹Øª Ø±Ø§Ø¨Ø·Ø§Ù‹ Ù‡Ù†Ø§.</small>
            </div>
            <div style="background:#f0fdf4; padding:15px; border-radius:15px; border:1px solid #2ecc71; margin-bottom:15px;"> <b>ğŸ”— Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„:</b> <input type="text" id="set-wa" placeholder="ÙˆØ§ØªØ³Ø§Ø¨"> <input type="text" id="set-tele" placeholder="ØªÙ„ÙŠØ¬Ø±Ø§Ù…"> <input type="text" id="set-face" placeholder="ÙÙŠØ³Ø¨ÙˆÙƒ"> <input type="text" id="set-tiktok" placeholder="ØªÙŠÙƒ ØªÙˆÙƒ"> </div>
            <button class="btn btn-main" onclick="saveSiteSettings()">Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
    </div>

    <div id="modal-edit" class="modal">
        <div class="modal-content"> <span onclick="document.getElementById('modal-edit').style.display='none'" class="modal-close">Ã—</span>
            <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h3> <input type="hidden" id="edit-id"> <input type="hidden" id="edit-col">
            <label>Ø§Ù„ØµÙ:</label> <select id="edit-grade"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option></select>
            <button class="btn btn-main" onclick="saveEdit()" style="margin-top:15px;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
    </div>

    <div id="modal-student-report" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span onclick="document.getElementById('modal-student-report').style.display='none'" class="modal-close">Ã—</span>
            <div id="report-content-area"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCgpj7MLByWpTVUE2Tg3DQ0pwsUjLhAyEM",
            authDomain: "ahmedead-5185c.firebaseapp.com",
            projectId: "ahmedead-5185c",
            storageBucket: "ahmedead-5185c.firebasestorage.app",
            messagingSenderId: "559908876854",
            appId: "1:559908876854:web:e8e7c151e984dc13219e97"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const gradeNames = { "all": "Ø§Ù„Ø¬Ù…ÙŠØ¹", "4": "Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "5": "Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "6": "Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "7": "Ø£ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "8": "Ø«Ø§Ù†ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "9": "Ø«Ø§Ù„Ø« Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ" };
        
        function showLoader() { document.getElementById('global-loader').style.display = 'flex'; }
        function hideLoader() { document.getElementById('global-loader').style.display = 'none'; }

        auth.onAuthStateChanged((user) => {
            if (user) { document.getElementById('login-overlay').style.display = 'none'; document.getElementById('admin-panel').style.display = 'block'; loadSettings(); }
            else { document.getElementById('login-overlay').style.display = 'flex'; document.getElementById('admin-panel').style.display = 'none'; }
        });

        function adminLogin() {
            const email = document.getElementById('adm-email').value; const pass = document.getElementById('adm-pass').value;
            showLoader(); auth.signInWithEmailAndPassword(email, pass).then(() => { Swal.fire({icon:'success', title:'ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„', timer:1500, showConfirmButton:false}); }).catch((e) => { Swal.fire({icon:'error', title:'Ø®Ø·Ø£', text:'ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'}); }).finally(() => hideLoader());
        }
        function adminLogout() { auth.signOut().then(() => location.reload()); }
        
        function showTab(id) {
            document.querySelectorAll('.admin-tab').forEach(t => t.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'tab-q') loadExamsToSelect();
            if(id === 'tab-create-exam') { loadExamsList(); loadExamsForMergeList(); }
            if(id === 'tab-posts') loadPostsList();
        }

        // --- 1. Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø¯Ù…Ø¬ ---
        function createExam(){
            const title = document.getElementById('exam-title').value;
            const grade = document.getElementById('exam-grade').value;
            const subject = document.getElementById('exam-subject').value;
            const category = document.getElementById('exam-category').value;
            
            if(!title || !category) return Swal.fire('Ø®Ø·Ø£','Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','error');
            
            db.collection('exams').add({
                title, grade, subject, category, createdAt: new Date().toISOString()
            }).then(()=>{
                Swal.fire('ØªÙ…','ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­','success');
                loadExamsList(); loadExamsForMergeList();
            });
        }

        function loadExamsList(){
            const div = document.getElementById('exams-list'); div.innerHTML='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            db.collection('exams').orderBy('createdAt','desc').get().then(snap=>{
                div.innerHTML='';
                snap.forEach(doc=>{
                    const e = doc.data();
                    div.innerHTML += `<div style="background:#fff; padding:10px; margin-bottom:5px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                        <span><b>${e.title}</b> <small style="color:#888;">(${e.category} - ${gradeNames[e.grade]})</small></span>
                        <button class="btn-del" onclick="deleteExam('${doc.id}')">Ø­Ø°Ù</button>
                    </div>`;
                });
            });
        }
        function deleteExam(id){ if(confirm('Ø­Ø°Ù Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ØŸ')) db.collection('exams').doc(id).delete().then(()=>{ loadExamsList(); loadExamsForMergeList(); }); }

        // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ù…Ø¬
        function loadExamsForMergeList() {
            const list = document.getElementById('merge-source-list');
            list.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            db.collection('exams').orderBy('createdAt', 'desc').get().then(snap => {
                list.innerHTML = '';
                snap.forEach(doc => {
                    const e = doc.data();
                    list.innerHTML += `
                        <div class="check-exam-box">
                            <input type="checkbox" class="merge-check" value="${doc.id}">
                            <span>${e.title} <small>(${gradeNames[e.grade] || e.grade})</small></span>
                        </div>
                    `;
                });
            });
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¯Ù…Ø¬ (Core Function)
        async function mergeExams() {
            const checkboxes = document.querySelectorAll('.merge-check:checked');
            const newTitle = document.getElementById('merge-title').value;
            const newGrade = document.getElementById('merge-grade').value;
            const newCategory = document.getElementById('merge-category').value;

            if (checkboxes.length === 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ø®ØªØ± Ø§Ù…ØªØ­Ø§Ù†Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¯Ù…Ø¬', 'warning');
            if (!newTitle) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯', 'warning');

            showLoader();

            try {
                // 1. Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const newExamRef = await db.collection('exams').add({
                    title: newTitle,
                    grade: newGrade,
                    subject: 'merged', // Ø£Ùˆ ÙŠÙ…ÙƒÙ† Ø¬Ø¹Ù„Ù‡Ø§ Ø®ÙŠØ§Ø±
                    category: newCategory,
                    createdAt: new Date().toISOString()
                });

                // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
                const examIds = Array.from(checkboxes).map(cb => cb.value);
                let allQuestions = [];

                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise.all Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ù„ØªÙˆØ§Ø²ÙŠ
                const fetchPromises = examIds.map(eid => 
                    db.collection('questions').where('examId', '==', eid).get()
                );
                
                const snapshots = await Promise.all(fetchPromises);
                snapshots.forEach(snap => {
                    snap.forEach(doc => {
                        allQuestions.push(doc.data());
                    });
                });

                if (allQuestions.length === 0) {
                    hideLoader();
                    return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø©!', 'info');
                }

                // 3. Ù†Ø³Ø® Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Batch Write)
                // Firestore batch limit is 500 operations.
                const batch = db.batch();
                let counter = 0;

                allQuestions.forEach(qData => {
                    const newQRef = db.collection('questions').doc(); // ID Ø¬Ø¯ÙŠØ¯
                    batch.set(newQRef, {
                        q: qData.q,
                        c: qData.c,
                        w: qData.w,
                        examId: newExamRef.id // Ø±Ø¨Ø· Ø¨Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    });
                    counter++;
                });

                await batch.commit();
                
                hideLoader();
                Swal.fire('ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† "${newTitle}" ÙˆØªÙ… Ù†Ø³Ø® ${counter} Ø³Ø¤Ø§Ù„ Ø¥Ù„ÙŠÙ‡.`, 'success');
                loadExamsList();
                // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById('merge-title').value = '';
                document.querySelectorAll('.merge-check').forEach(c => c.checked = false);

            } catch (error) {
                hideLoader();
                console.error(error);
                Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ù…Ø¬: ' + error.message, 'error');
            }
        }


        // --- 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ---
        function loadExamsToSelect(){
            const sel = document.getElementById('target-exam-select');
            sel.innerHTML = '<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>';
            db.collection('exams').orderBy('createdAt','desc').get().then(snap=>{
                sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† --</option>';
                snap.forEach(doc=>{
                    const e = doc.data();
                    const opt = document.createElement('option');
                    opt.value = doc.id;
                    opt.innerText = `${e.title} (${gradeNames[e.grade]})`;
                    sel.appendChild(opt);
                });
            });
        }
        function loadExamQuestionsCount(){
            const id = document.getElementById('target-exam-select').value;
            if(!id) return;
            db.collection('questions').where('examId','==',id).get().then(snap=>{
                document.getElementById('exam-q-info').innerText = `ÙŠØ­ØªÙˆÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¹Ù„Ù‰ ${snap.size} Ø£Ø³Ø¦Ù„Ø©`;
            });
        }
        function addQuestionToExam(){
            const examId = document.getElementById('target-exam-select').value;
            if(!examId) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø£ÙˆÙ„Ø§Ù‹','warning');
            db.collection('questions').add({
                examId: examId,
                q: document.getElementById('q-text').value,
                c: document.getElementById('q-c').value,
                w: [document.getElementById('q-w1').value, document.getElementById('q-w2').value, "Ø®Ø·Ø£"]
            }).then(()=>{ Swal.fire('ØªÙ…','','success'); document.getElementById('q-text').value=''; loadExamQuestionsCount(); });
        }
        function addBulkQuestions(){
            const examId = document.getElementById('target-exam-select').value;
            if(!examId) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø£ÙˆÙ„Ø§Ù‹','warning');
            try {
                const data = JSON.parse(document.getElementById('in-bulk').value);
                const batch = db.batch();
                data.forEach(item => { const ref = db.collection('questions').doc(); batch.set(ref, { ...item, examId: examId }); });
                batch.commit().then(()=>{ Swal.fire('ØªÙ… Ø§Ù„Ø±ÙØ¹','','success'); loadExamQuestionsCount(); });
            } catch(e) { Swal.fire('Ø®Ø·Ø£ JSON','','error'); }
        }

        // --- 3 & 4. Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ ---
        function saveLesson() { db.collection("lessons").add({ grade: document.getElementById('in-l-grade').value, title: document.getElementById('in-l-tit').value, body: document.getElementById('in-l-bod').value, img: document.getElementById('in-l-img').value }).then(() => Swal.fire('ØªÙ… Ø§Ù„Ù†Ø´Ø±', '', 'success')).catch(e => alert("Ø®Ø·Ø£")); }
        function saveVideo() { db.collection("videos").add({ grade: document.getElementById('in-v-grade').value, title: document.getElementById('v-tit').value, url: document.getElementById('v-url').value }).then(() => Swal.fire('ØªÙ… Ø§Ù„Ù†Ø´Ø±', '', 'success')).catch(e => alert("Ø®Ø·Ø£")); }

        // --- 5. Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ---
        function loadExamsForPosts() {
            const sel = document.getElementById('post-exam-select');
            sel.innerHTML = '<option value="">-- Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„... --</option>';
            db.collection('exams').orderBy('createdAt','desc').limit(20).get().then(snap => {
                sel.innerHTML = '<option value="">-- Ø¨Ø¯ÙˆÙ† Ø§Ù…ØªØ­Ø§Ù† --</option>';
                snap.forEach(doc => {
                    sel.innerHTML += `<option value="${doc.id}">${doc.data().title}</option>`;
                });
            });
        }
        function createPost() {
            const title = document.getElementById('post-title').value;
            const body = document.getElementById('post-body').value;
            const img = document.getElementById('post-img').value;
            const examId = document.getElementById('post-exam-select').value;
            const grade = document.getElementById('post-grade').value;

            if(!title && !body) return Swal.fire('Ø®Ø·Ø£', 'ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ù†Øµ Ù„Ù„Ù…Ù†Ø´ÙˆØ±', 'warning');

            db.collection('posts').add({
                title, body, img, examId, grade,
                timestamp: new Date().toISOString()
            }).then(() => {
                Swal.fire('ØªÙ… Ø§Ù„Ù†Ø´Ø±', '', 'success');
                loadPostsList();
                // Reset
                document.getElementById('post-title').value = '';
                document.getElementById('post-body').value = '';
            });
        }
        function loadPostsList() {
            const div = document.getElementById('posts-list-manage');
            div.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            db.collection('posts').orderBy('timestamp', 'desc').get().then(snap => {
                div.innerHTML = '';
                snap.forEach(doc => {
                    const p = doc.data();
                    div.innerHTML += `
                        <div style="background:white; padding:10px; margin-bottom:5px; border:1px solid #eee; display:flex; justify-content:space-between;">
                            <div><b>${p.title}</b> <small>(${gradeNames[p.grade]})</small></div>
                            <button class="btn-del" onclick="db.collection('posts').doc('${doc.id}').delete().then(()=>loadPostsList())">Ø­Ø°Ù</button>
                        </div>
                    `;
                });
            });
        }


        // --- 6. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ---
        function loadManageData(type, btn) {
            if(btn) { document.querySelectorAll('.manage-filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            const list = document.getElementById('mng-list'); list.innerHTML = '<p style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...</p>';
            let items = []; const promises = [];
            if(type === 'all' || type === 'questions') promises.push(db.collection("questions").get().then(s => s.forEach(d => items.push({id: d.id, ...d.data(), col:'questions', lbl:'Ø³Ø¤Ø§Ù„'}))));
            if(type === 'all' || type === 'lessons') promises.push(db.collection("lessons").get().then(s => s.forEach(d => items.push({id: d.id, ...d.data(), col:'lessons', lbl:'Ø¯Ø±Ø³'}))));
            if(type === 'all' || type === 'videos') promises.push(db.collection("videos").get().then(s => s.forEach(d => items.push({id: d.id, ...d.data(), col:'videos', lbl:'ÙÙŠØ¯ÙŠÙˆ'}))));
            Promise.all(promises).then(() => { list.innerHTML = items.length ? items.map(i => `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee; margin-bottom:5px;"><div><b>${(i.q || i.title || "").substring(0,40)}</b> <span style="font-size:12px; color:#888;">(${i.lbl})</span></div><div><button class="btn-edit" onclick="openEditModal('${i.id}','${i.col}','${i.grade}')"><i class="fas fa-pen"></i></button><button class="btn-del" onclick="delDoc('${i.col}','${i.id}')"><i class="fas fa-trash"></i></button></div></div>`).join('') : '<p style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰</p>'; });
        }
        function delDoc(c, id) { if(confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ")) { db.collection(c).doc(id).delete().then(() => loadManageData('all')); } }
        function openEditModal(id, c, g) { document.getElementById('edit-id').value = id; document.getElementById('edit-col').value = c; document.getElementById('edit-grade').value = g || 'all'; document.getElementById('modal-edit').style.display = 'flex'; }
        function saveEdit() { const id = document.getElementById('edit-id').value; const col = document.getElementById('edit-col').value; db.collection(col).doc(id).update({ grade: document.getElementById('edit-grade').value }).then(() => { document.getElementById('modal-edit').style.display = 'none'; Swal.fire('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', '', 'success'); loadManageData('all'); }); }

        // --- 7. Ø§Ù„Ø·Ù„Ø§Ø¨ ---
        function loadStudents(){
            const tb = document.getElementById('users-body'); tb.innerHTML = '<tr><td colspan="4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            db.collection('users').get().then(snap=>{
                tb.innerHTML = '';
                snap.forEach(d=>{
                    const u = d.data();
                    tb.innerHTML += `<tr>
                        <td>${u.name}</td> <td>${gradeNames[u.grade] || u.grade}</td> <td>${u.email}</td>
                        <td>
                            <button class="btn btn-sec" style="font-size:12px; padding:5px 10px; width:auto;" onclick="grantBadge('${d.id}')" title="Ù…Ù†Ø­ ÙˆØ³Ø§Ù…"><i class="fas fa-medal"></i></button>
                            <button class="btn btn-report" style="font-size:12px; padding:5px 10px; width:auto;" onclick="viewStudentReport('${d.id}', '${u.name}', '${u.grade}')" title="ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„"><i class="fas fa-file-alt"></i> ØªÙ‚Ø±ÙŠØ±</button>
                            <button class="btn btn-del" style="font-size:12px; padding:5px 10px; width:auto;" onclick="deleteStudent('${d.id}')" title="Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨"><i class="fas fa-user-slash"></i></button>
                        </td>
                    </tr>`;
                });
            });
        }
        function deleteStudent(uid) {
            Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ', text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ø­Ø°Ù', cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((result) => { if (result.isConfirmed) { db.collection('users').doc(uid).delete().then(() => { Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù!', '', 'success'); loadStudents(); }); } })
        }
        function viewStudentReport(uid, name, grade) {
            showLoader(); const reportArea = document.getElementById('report-content-area'); reportArea.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</p>'; document.getElementById('modal-student-report').style.display = 'flex';
            Promise.all([ db.collection("results").where("name", "==", name).get(), db.collection("user_badges").where("uid", "==", uid).get() ]).then((snapshots) => {
                const resultsSnap = snapshots[0]; const badgesSnap = snapshots[1];
                let totalExams = 0, totalScoreSum = 0, totalMaxScore = 0, historyHtml = '';
                resultsSnap.forEach(doc => { const r = doc.data(); totalExams++; totalScoreSum += Number(r.score); totalMaxScore += Number(r.total); const per = (r.score / r.total) * 100; historyHtml += `<tr><td>${r.examType}</td><td style="color:${per>=50?'green':'red'}">${r.score}/${r.total}</td><td>${per.toFixed(1)}%</td><td>${new Date(r.date).toLocaleDateString()}</td></tr>`; });
                let avgPercent = totalMaxScore > 0 ? (totalScoreSum / totalMaxScore) * 100 : 0;
                let levelText = avgPercent >= 90 ? "Ù…Ù…ØªØ§Ø² ğŸŒŸ" : avgPercent >= 75 ? "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ ğŸ‘" : avgPercent >= 50 ? "Ù…ØªÙˆØ³Ø· ğŸ‘Œ" : "ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† âš ï¸";
                reportArea.innerHTML = `<div class="report-header"><h3>${name}</h3><span>${gradeNames[grade]||grade}</span></div> <div class="report-stats"><div class="stat-box"><h4>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</h4><p>${levelText}</p></div> <div class="stat-box"><h4>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h4><p>${totalExams}</p></div> <div class="stat-box"><h4>Ø§Ù„Ø£ÙˆØ³Ù…Ø©</h4><p>${badgesSnap.size}</p></div></div> <h4>Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª:</h4> <div style="overflow-x:auto;"><table><thead><tr><th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>%</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody>${historyHtml||'<tr><td colspan=4>Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}</tbody></table></div>`; hideLoader();
            });
        }

        async function grantBadge(uid){ const {value:t} = await Swal.fire({input:'text', inputLabel:'Ø§Ø³Ù… Ø§Ù„ÙˆØ³Ø§Ù…'}); if(t) db.collection('user_badges').add({ uid, title:t, icon:'fas fa-medal', color:'gold', timestamp:new Date().toISOString() }).then(()=>Swal.fire('ØªÙ…')); }
        function createRule(){ const t=document.getElementById('badge-title').value; const i=document.getElementById('badge-icon').value; const c=document.getElementById('badge-cond').value; const th=Number(document.getElementById('badge-thresh').value); db.collection('badges_rules').add({title:t, icon:i, condition:c, threshold:th, type:'auto', color:'gold'}).then(()=>{ Swal.fire('ØªÙ…'); loadBadgeRules(); }); }
        function loadBadgeRules(){ const l=document.getElementById('rules-list'); l.innerHTML=''; db.collection('badges_rules').get().then(s=>{ s.forEach(d=>{ l.innerHTML+=`<div>${d.data().title} <button class="btn-del" onclick="db.collection('badges_rules').doc('${d.id}').delete().then(()=>loadBadgeRules())">x</button></div>`; }); }); }

        // --- 9. Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ---
        function loadStudentResults() { const tbody = document.getElementById('results-body'); tbody.innerHTML = '<tr><td colspan="6">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>'; db.collection("results").get().then(snap => { let docs = []; snap.forEach(d => docs.push({id: d.id, ...d.data()})); docs.sort((a,b) => new Date(b.date) - new Date(a.date)); tbody.innerHTML = docs.map(r => `<tr><td>${new Date(r.date).toLocaleDateString('ar-EG')}</td><td>${r.name}</td><td>${gradeNames[r.grade]||r.grade}</td><td>${r.examType}</td><td style="color:${(r.score/r.total)>=0.7?'green':'red'}">${r.score}/${r.total}</td><td><button class="btn-small-danger" onclick="delRes('${r.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join('') || '<tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>'; }); }
        function delRes(id) { if(confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†ØªÙŠØ¬Ø©ØŸ")) db.collection("results").doc(id).delete().then(() => loadStudentResults()); }
        function clearResults() { if(confirm("Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) { db.collection("results").get().then(snap => { const batch = db.batch(); snap.forEach(d => batch.delete(d.ref)); batch.commit().then(() => loadStudentResults()); }); } }

        // --- 10. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
        function loadSettings() { 
            db.collection("settings").doc("site_info").get().then(s => { 
                if(s.exists) { 
                    const d = s.data(); 
                    document.getElementById('set-title').value = d.title || ""; 
                    document.getElementById('set-logo').value = d.logo || ""; 
                    document.getElementById('set-desc').value = d.description || "";
                    document.getElementById('set-app-url').value = d.appUrl || ""; // Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                    document.getElementById('set-wa').value = d.wa || ""; 
                    document.getElementById('set-tele').value = d.tele || ""; 
                    document.getElementById('set-face').value = d.face || ""; 
                    document.getElementById('set-tiktok').value = d.tiktok || ""; 
                } 
            }); 
        }
        function saveSiteSettings() { 
            let wa = document.getElementById('set-wa').value; 
            if(wa && !wa.startsWith('http')) wa = `https://wa.me/20${wa.replace(/^0+/,'')}`; 
            db.collection("settings").doc("site_info").set({ 
                title: document.getElementById('set-title').value, 
                logo: document.getElementById('set-logo').value, 
                description: document.getElementById('set-desc').value,
                appUrl: document.getElementById('set-app-url').value, // Ø­ÙØ¸ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                wa: wa, 
                tele: document.getElementById('set-tele').value, 
                face: document.getElementById('set-face').value, 
                tiktok: document.getElementById('set-tiktok').value 
            }, {merge: true}).then(() => Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸', '', 'success')); 
        }
    </script>
</body></html>