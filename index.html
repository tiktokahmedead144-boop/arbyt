<!doctype html>
<html lang="ar" dir="rtl"> 
 <head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØµØ© Ù„ØºØªÙŠ Ù‡ÙˆÙŠØªÙŠ - Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©</title> 
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&amp;display=swap" rel="stylesheet"> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> 
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script> 
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script> 
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script> 
  <style>
        /* --- Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£ØµÙ„ÙŠ + Ø¥Ø¶Ø§ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø© --- */
        :root { 
            --main: #4a90e2; --sec: #2ecc71; --vocab: #9b59b6; 
            --video: #e67e22; --err: #e74c3c; --bg: #f4f7f6; 
            --white: #ffffff; --text: #2d3436; 
        }
        * { box-sizing: border-box; transition: 0.3s; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 20px; min-height: 100vh; }
        
        .container { 
            width: 100%; max-width: 1000px; background: var(--white); 
            border-radius: 30px; padding: 30px; margin: 0 auto; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
        }
        
        h2, h3 { color: var(--main); font-weight: 900; margin-top: 0; }
        
        input, select, textarea { 
            width: 100%; padding: 12px; margin: 8px 0; 
            border: 1px solid #cbd5e1; border-radius: 12px; 
            font-size: 15px; outline: none; display: block; 
        }
        input:focus, select:focus, textarea:focus { border-color: var(--main); }
        
        .btn { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; margin-bottom: 10px; color: white; font-size: 16px; display: inline-flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-main { background: var(--main); }
        .btn-sec { background: var(--sec); }
        .btn-video { background: var(--video); }
        .btn-del { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; width: auto; padding: 5px 10px; font-size: 12px; border-radius: 5px; cursor: pointer; }
        .btn-edit { background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; width: auto; padding: 5px 10px; font-size: 12px; margin-left: 5px; border-radius: 5px; cursor: pointer; }
        .btn-report { background: #e0e7ff; color: #4338ca; border: 1px solid #c7d2fe; width: auto; padding: 5px 10px; font-size: 12px; margin-left: 5px; border-radius: 5px; cursor: pointer; }
        .btn-outline { background: #fff; border: 2px solid #e2e8f0; color: #64748b; }
        
        .admin-nav { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .admin-nav button { flex: 1; min-width: 130px; font-size: 13px; margin: 0; border-radius: 20px; }
        .admin-tab { display: none; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        #login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        
        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background: #f1f5f9; color: var(--main); white-space: nowrap; }
        
        .check-list-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .check-list-item:hover { background: #f9f9f9; }
        .check-list-item input { width: 20px; height: 20px; margin: 0; cursor: pointer; }

        /* Ø§Ù„Ø´Ø§Øª */
        .chat-list-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .chat-list-item:hover { background: #f0f9ff; }
        .msg-box { height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px; border-radius: 10px; background: #fafafa; }
        .adm-msg { align-self: flex-end; background: var(--main); color: white; padding: 6px 12px; border-radius: 10px; max-width: 80%; }
        .stu-msg { align-self: flex-start; background: #e2e8f0; padding: 6px 12px; border-radius: 10px; max-width: 80%; }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20000; justify-content: center; align-items: center; padding: 15px; }
        .modal-content { background: white; width: 100%; max-width: 750px; border-radius: 20px; padding: 25px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-close { position: absolute; left: 20px; top: 20px; font-size: 25px; cursor: pointer; color: #aaa; }
        
        #global-loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 30000; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #eee; border-top-color: var(--main); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to {transform: rotate(360deg);} }

        /* ÙÙ„Ø§ØªØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
        .manage-filter-bar { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .manage-filter-btn { padding: 5px 15px; border-radius: 15px; border: 1px solid #eee; background: white; cursor: pointer; font-size: 13px; }
        .manage-filter-btn.active { background: var(--main); color: white; border-color: var(--main); }
        .btn-small-danger { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; font-size: 11px; padding: 4px 8px; border-radius: 6px; width: auto; display: inline-block; cursor: pointer; float: left; }
    </style> 
 </head> 
 <body> 
  <div id="global-loader"> 
   <div class="spinner"></div> 
  </div> 

  <div id="login-overlay"> 
   <div id="login-box"> 
    <img src="https://cdn-icons-png.flaticon.com/512/3426/3426653.png" width="80" style="margin-bottom:20px;"> 
    <h2>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2> 
    <input type="email" id="adm-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"> 
    <input type="password" id="adm-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"> 
    <button class="btn btn-main" onclick="adminLogin()">Ø¯Ø®ÙˆÙ„</button> 
   </div> 
  </div> 

  <div class="container" id="admin-panel" style="display: none;"> 
   <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"> 
    <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„Ø© âš™ï¸</h2> 
    <a href="index.html" target="_blank" class="btn btn-outline" style="width: auto; padding: 8px 15px;">Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø·Ø§Ù„Ø¨ <i class="fas fa-external-link-alt"></i></a> 
   </div> 

   <div class="admin-nav"> 
    <button class="btn btn-main" onclick="showTab('tab-create-exam')">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù…ØªØ­Ø§Ù†</button> 
    <button class="btn btn-main" onclick="showTab('tab-q')">â• Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø©</button> 
    <button class="btn btn-main" style="background:#8e44ad; border-color:#8e44ad;" onclick="showTab('tab-merge')">ğŸ”„ Ø¯Ù…Ø¬ ÙˆÙ†Ø³Ø®</button>
    
    <button class="btn btn-sec" onclick="showTab('tab-l')">ğŸ“š Ø§Ù„Ù…ÙƒØªØ¨Ø©</button> 
    <button class="btn btn-video" onclick="showTab('tab-v')">ğŸ¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</button> 
    
    <button class="btn btn-outline" style="color:#e67e22; border-color:#e67e22;" onclick="showTab('tab-posts')">ğŸ“¢ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…</button>
    <button class="btn btn-outline" onclick="showTab('tab-mng'); loadManageExams();">ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰</button> 
    <button class="btn btn-outline" onclick="showTab('tab-msgs'); loadMessagesList();">ğŸ“© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</button> 
    <button class="btn btn-outline" onclick="showTab('tab-users'); loadStudents();">ğŸ‘¥ Ø§Ù„Ø·Ù„Ø§Ø¨</button> 
    <button class="btn btn-outline" onclick="showTab('tab-rules'); loadBadgeRules();">ğŸ… Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</button> 
    <button class="btn btn-outline" onclick="showTab('tab-pub'); loadPubComments();">ğŸŒ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</button> 
    <button class="btn btn-outline" onclick="showTab('tab-results'); loadStudentResults();">ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button> 
    <button class="btn btn-outline" onclick="showTab('tab-settings')" style="color:#4a90e2;">ğŸ› ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button> 
    <button class="btn btn-outline" onclick="adminLogout()" style="color:red; flex:0;">Ø®Ø±ÙˆØ¬</button> 
   </div> 

   <div id="tab-create-exam" class="admin-tab" style="display: block;"> 
    <h3>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª (Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª)</h3> 
    <div style="background:#f0f9ff; padding:15px; border-radius:15px; border:1px solid #bae6fd;"> 
     <input id="exam-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† (Ù…Ø«Ù„Ø§Ù‹: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„ - Ø£ÙƒØªÙˆØ¨Ø±)"> 
     <div style="display:flex; gap:10px;"> 
         <select id="exam-grade"> <option value="4">4 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="5">5 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="6">6 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option> <option value="7">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="8">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="9">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option> </select> 
         <select id="exam-subject"> <option value="grammar">Ù†Ø­Ùˆ</option> <option value="vocab">Ù…ÙØ±Ø¯Ø§Øª</option> </select> 
     </div> 
     <select id="exam-category"> 
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ --</option> 
        <option value="Ø£Ø³Ø¨ÙˆØ¹ÙŠ">ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</option> <option value="Ø´Ø§Ù…Ù„">Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø´Ø§Ù…Ù„Ø©</option> 
        <option value="ØªØ±Ù…1">ØªØ±Ù… Ø£ÙˆÙ„</option> <option value="ØªØ±Ù…2">ØªØ±Ù… Ø«Ø§Ù†ÙŠ</option> 
        <option value="Ø£ÙƒØªÙˆØ¨Ø±">Ø£ÙƒØªÙˆØ¨Ø±</option> <option value="Ù†ÙˆÙÙ…Ø¨Ø±">Ù†ÙˆÙÙ…Ø¨Ø±</option> <option value="Ø¯ÙŠØ³Ù…Ø¨Ø±">Ø¯ÙŠØ³Ù…Ø¨Ø±</option> 
        <option value="ÙØ¨Ø±Ø§ÙŠØ±">ÙØ¨Ø±Ø§ÙŠØ±</option> <option value="Ù…Ø§Ø±Ø³">Ù…Ø§Ø±Ø³</option> <option value="Ø£Ø¨Ø±ÙŠÙ„">Ø£Ø¨Ø±ÙŠÙ„</option> 
     </select> 
     <button class="btn btn-main" onclick="createExam()">Ø­ÙØ¸ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯</button> 
    </div> 
    <h3>Ø£Ø­Ø¯Ø« Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©:</h3> 
    <div id="exams-list-preview"></div> 
   </div> 

   <div id="tab-q" class="admin-tab"> 
    <h3>Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ø­Ø¯Ø¯</h3> 
    <div style="background:#fff; padding:15px; border-radius:15px; border:1px solid #eee;"> 
     <label style="color:red; font-weight:bold;">1. Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø°ÙŠ Ø³ØªØ¶ÙŠÙ ÙÙŠÙ‡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label> 
     <select id="target-exam-select" onchange="loadExamQuestionsCount()"> <option value="">-- Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„... --</option> </select> 
     <div id="exam-q-info" style="color:green; font-weight:bold; margin-bottom:10px;"></div> 
    </div> 
    <div class="bulk-area" style="margin-top:15px;"> 
     <b>ğŸš€ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø¬Ù…Ø¹ (JSON):</b> 
     <textarea id="in-bulk" rows="3" placeholder="[{&quot;q&quot;:&quot;Ø³Ø¤Ø§Ù„&quot;,&quot;c&quot;:&quot;ØµØ­&quot;,&quot;w&quot;:[&quot;Ø®1&quot;,&quot;Ø®2&quot;]}]"></textarea> 
     <button class="btn btn-main" onclick="addBulkQuestions()">Ø±ÙØ¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button> 
    </div> 
    <div style="margin-top:15px; border-top:1px solid #ddd; padding-top:10px;"> 
     <b>Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯:</b> 
     <input id="q-text" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„"> 
     <input id="q-c" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©"> 
     <input id="q-w1" placeholder="Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© 1"> 
     <input id="q-w2" placeholder="Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© 2"> 
     <button class="btn btn-sec" onclick="addQuestionToExam()">Ø­ÙØ¸ Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯</button> 
    </div> 
   </div> 

   <div id="tab-merge" class="admin-tab">
       <h3>ğŸ”„ Ø¯Ù…Ø¬ ÙˆÙ†Ø³Ø® Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h3>
       <div style="background:#fffbe6; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #ffe58f;">
           <p style="margin:0 0 10px;">Ù‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± ØµÙ ÙˆÙ…Ø§Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§ØªØŒ Ø«Ù… Ø­Ø¯Ø¯ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¯Ù…Ø¬Ù‡Ø§ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…Ø¬Ù…Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©.</p>
           <div style="display:flex; gap:10px;">
               <select id="merge-grade" onchange="loadExamsForMerge()">
                   <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
                   <option value="4">4 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="5">5 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="6">6 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                   <option value="7">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="8">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="9">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
               </select>
               <select id="merge-subject" onchange="loadExamsForMerge()">
                   <option value="grammar">Ù†Ø­Ùˆ</option><option value="vocab">Ù…ÙØ±Ø¯Ø§Øª</option>
               </select>
           </div>
       </div>
       <div id="merge-list" style="max-height:250px; overflow-y:auto; border:1px solid #eee; padding:10px; margin-bottom:15px; background:white;">
           <p style="color:#888; text-align:center;">Ø§Ø®ØªØ± Ø§Ù„ØµÙ ÙˆØ§Ù„Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹...</p>
       </div>
       <div style="border-top:1px solid #eee; padding-top:15px;">
           <h4>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¬Ù…Ø¹:</h4>
           <input id="new-merge-title" placeholder="Ø§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© - ØªØ±Ù… Ø£ÙˆÙ„)">
           <select id="new-merge-category"> 
                <option value="">-- Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ --</option> 
                <option value="Ø´Ø§Ù…Ù„">Ø´Ø§Ù…Ù„</option> <option value="ØªØ±Ù…1">ØªØ±Ù… Ø£ÙˆÙ„</option> <option value="ØªØ±Ù…2">ØªØ±Ù… Ø«Ø§Ù†ÙŠ</option> 
                <option value="Ø£ÙƒØªÙˆØ¨Ø±">Ø£ÙƒØªÙˆØ¨Ø±</option> <option value="Ø£Ø³Ø¨ÙˆØ¹ÙŠ">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
           </select>
           <button class="btn btn-main" style="background:#8e44ad;" onclick="executeMerge()">ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯Ù…Ø¬ ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø¢Ù†</button>
       </div>
   </div>

   <div id="tab-l" class="admin-tab"> 
    <h3>Ù†Ø´Ø± Ø¯Ø±Ø³</h3> 
    <select id="in-l-grade">
        <option value="all">ğŸŒ Ø¹Ø§Ù… Ù„ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹)</option>
        <option value="4">4 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="5">5 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="6">6 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
        <option value="7">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="8">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="9">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
    </select> 
    <input id="in-l-tit" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³"> 
    <textarea id="in-l-bod" rows="6" placeholder="Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø´Ø±Ø­..."></textarea> 
    <input id="in-l-img" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"> 
    <button class="btn btn-sec" onclick="saveLesson()">Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³</button> 
   </div> 

   <div id="tab-v" class="admin-tab"> 
    <h3>Ù†Ø´Ø± ÙÙŠØ¯ÙŠÙˆ</h3> 
    <select id="in-v-grade">
        <option value="all">ğŸŒ Ø¹Ø§Ù… Ù„ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹)</option>
        <option value="4">4 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="5">5 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="6">6 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
        <option value="7">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="8">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="9">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
    </select> 
    <input id="v-tit" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ"> 
    <input id="v-url" placeholder="Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ Ø£Ùˆ ØªÙŠÙƒ ØªÙˆÙƒ"> 
    <button class="btn btn-video" onclick="saveVideo()">Ù†Ø´Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button> 
   </div> 

   <div id="tab-posts" class="admin-tab">
       <h3>ğŸ“¢ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… (Wall)</h3>
       <div style="background:#fff0f6; padding:15px; border-radius:15px; border:1px solid #ffdeeb;">
           <input id="post-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±">
           <textarea id="post-body" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù‡Ù†Ø§..."></textarea>
           <input id="post-img" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ù„Ù„Ù…Ù†Ø´ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
           
           <div style="margin-top:10px; padding:10px; background:white; border-radius:10px;">
               <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø¥Ø±ÙØ§Ù‚ Ù…Ø­ØªÙˆÙ‰ ØªÙØ§Ø¹Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
               <select id="post-attach-type" onchange="togglePostAttach()">
                   <option value="none">-- Ø¨Ø¯ÙˆÙ† Ù…Ø±ÙÙ‚Ø§Øª --</option>
                   <option value="exam">ğŸ“ Ø¥Ø±ÙØ§Ù‚ Ø§Ù…ØªØ­Ø§Ù†</option>
                   <option value="lesson">ğŸ“ Ø¥Ø±ÙØ§Ù‚ Ø¯Ø±Ø³ Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø©</option>
               </select>
               <select id="post-attach-id" style="display:none; margin-top:5px;"></select>
           </div>
           
           <button class="btn btn-main" style="background:#e67e22; margin-top:10px;" onclick="createPost()">Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
       </div>
       <h3 style="margin-top:20px;">Ø³Ø¬Ù„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h3>
       <div id="posts-list-manage"></div>
   </div>

   <div id="tab-mng" class="admin-tab"> 
    <h3>Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h3> 
    <div class="manage-filter-bar"> 
        <button class="manage-filter-btn active" onclick="loadManageExams()">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</button> 
        <button class="manage-filter-btn" onclick="loadManageData('lessons', this)">Ø§Ù„Ø¯Ø±ÙˆØ³</button> 
        <button class="manage-filter-btn" onclick="loadManageData('videos', this)">Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</button> 
    </div> 
    
    <div id="mng-search-area" style="margin-bottom:10px;">
        <input type="text" id="search-mng" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." onkeyup="filterManageList()">
    </div>

    <div id="mng-list" style="max-height:500px; overflow-y:auto; background:white; padding:10px; border-radius:10px; border:1px solid #ddd;"></div> 
   </div> 

   <div id="tab-msgs" class="admin-tab"> 
    <h3>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3> 
    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:15px;"> 
     <div id="msg-list" style="border:1px solid #eee; height:400px; overflow-y:auto; border-radius:10px;"></div> 
     <div id="msg-view" style="display:none; flex-direction:column;"> 
      <div id="chat-header" style="padding:10px; background:#f9f9f9; font-weight:bold; border-bottom:1px solid #eee;"></div> 
      <div id="admin-chat-box" class="msg-box"></div> 
      <div style="display:flex; gap:5px;"> 
       <input id="adm-reply-inp" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ..."> <button class="btn btn-main" style="width:auto;" onclick="sendReply()">Ø¥Ø±Ø³Ø§Ù„</button> 
      </div> 
     </div> 
    </div> 
   </div> 
   <div id="tab-users" class="admin-tab"> 
    <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3> 
    <div style="overflow-x:auto;"> 
     <table class="results-table"> 
      <thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead> 
      <tbody id="users-body"><tr><td colspan="4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody> 
     </table> 
    </div> 
   </div> 
   <div id="tab-rules" class="admin-tab"> 
    <h3>Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</h3> 
    <div style="background:#fffbe6; padding:10px; margin-bottom:10px; border:1px solid #ffe58f;"> 
     <input id="badge-title" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø©"> <input id="badge-icon" placeholder="Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (fas fa-star)"> 
     <select id="badge-cond"><option value="exams_count">Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</option><option value="perfect_score">Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</option></select> 
     <input id="badge-thresh" type="number" placeholder="Ø§Ù„Ø¹Ø¯Ø¯"> <button class="btn btn-main" onclick="createRule()">Ø¥Ø¶Ø§ÙØ©</button> 
    </div> 
    <div id="rules-list"></div> 
   </div> 
   <div id="tab-pub" class="admin-tab"> 
    <h3>ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</h3> <div id="adm-pub-list"></div> 
   </div> 
   <div id="tab-results" class="admin-tab"> 
    <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h3> <button class="btn-small-danger" onclick="clearResults()">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button> 
    <div style="clear:both; height:10px;"></div> 
    <div style="overflow-x:auto;"> 
     <table class="results-table"> 
      <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>Ø­Ø°Ù</th></tr></thead> 
      <tbody id="results-body"></tbody> 
     </table> 
    </div> 
   </div> 
   <div id="tab-settings" class="admin-tab"> 
    <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3> 
    <div style="background:#f0f7ff; padding:15px; border-radius:15px; border:1px solid #4a90e2;"> 
     <input type="text" id="set-title" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØµØ©"> 
     <input type="text" id="set-logo" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø±"> 
     <textarea id="set-desc" rows="4" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØµØ©..."></textarea> 
    </div> 
    <div style="margin-top:10px;"> 
     <input type="text" id="set-wa" placeholder="ÙˆØ§ØªØ³Ø§Ø¨"> <input type="text" id="set-tele" placeholder="ØªÙ„ÙŠØ¬Ø±Ø§Ù…"> 
     <input type="text" id="set-face" placeholder="ÙÙŠØ³Ø¨ÙˆÙƒ"> <input type="text" id="set-tiktok" placeholder="ØªÙŠÙƒ ØªÙˆÙƒ"> 
    </div> <button class="btn btn-main" onclick="saveSiteSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button> 
   </div> 
  </div> 

  <div id="modal-edit" class="modal"> 
   <div class="modal-content"> <span onclick="document.getElementById('modal-edit').style.display='none'" class="modal-close">Ã—</span> 
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h3> 
    <input type="hidden" id="edit-id"> <input type="hidden" id="edit-col"> 
    <label>Ø§Ù„ØµÙ:</label> 
    <select id="edit-grade">
        <option value="all">Ø¹Ø§Ù… Ù„Ù„Ø¬Ù…ÙŠØ¹</option>
        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
        <option value="7">7</option><option value="8">8</option><option value="9">9</option>
    </select> 
    <button class="btn btn-main" onclick="saveEdit()" style="margin-top:15px;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button> 
   </div> 
  </div> 

  <div id="modal-deep-edit" class="modal">
      <div class="modal-content">
          <span class="modal-close" onclick="document.getElementById('modal-deep-edit').style.display='none'">Ã—</span>
          <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
          <input type="hidden" id="deep-edit-id">
          
          <div style="background:#f9f9f9; padding:10px; border-radius:10px; margin-bottom:15px; border:1px solid #eee;">
              <h4 style="margin-top:0;">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</h4>
              <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:</label> <input id="deep-tit">
              <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Ø§Ù„ØµÙ:</label> 
                    <select id="deep-grade">
                        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                        <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                    </select>
                </div>
                <div style="flex:1;"><label>Ø§Ù„ØªØµÙ†ÙŠÙ:</label> 
                    <select id="deep-cat"> 
                        <option value="Ø£Ø³Ø¨ÙˆØ¹ÙŠ">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option> <option value="Ø´Ø§Ù…Ù„">Ø´Ø§Ù…Ù„</option> 
                        <option value="ØªØ±Ù…1">ØªØ±Ù… Ø£ÙˆÙ„</option> <option value="ØªØ±Ù…2">ØªØ±Ù… Ø«Ø§Ù†ÙŠ</option> 
                        <option value="Ø£ÙƒØªÙˆØ¨Ø±">Ø£ÙƒØªÙˆØ¨Ø±</option> <option value="Ù†ÙˆÙÙ…Ø¨Ø±">Ù†ÙˆÙÙ…Ø¨Ø±</option> <option value="Ø¯ÙŠØ³Ù…Ø¨Ø±">Ø¯ÙŠØ³Ù…Ø¨Ø±</option> 
                    </select>
                </div>
              </div>
              <button class="btn btn-main" onclick="saveDeepExamInfo()">Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙÙ‚Ø·</button>
          </div>

          <div style="border-top:2px solid #eee; padding-top:10px;">
              <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (<span id="deep-q-count">0</span>):</h4>
              <div id="deep-q-list" style="max-height:300px; overflow-y:auto;"></div>
          </div>
      </div>
  </div>

  <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCgpj7MLByWpTVUE2Tg3DQ0pwsUjLhAyEM",
            authDomain: "ahmedead-5185c.firebaseapp.com",
            projectId: "ahmedead-5185c",
            storageBucket: "ahmedead-5185c.firebasestorage.app",
            messagingSenderId: "559908876854",
            appId: "1:559908876854:web:e8e7c151e984dc13219e97"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const gradeNames = { "4": "Ø±Ø§Ø¨Ø¹", "5": "Ø®Ø§Ù…Ø³", "6": "Ø³Ø§Ø¯Ø³", "7": "Ø£ÙˆÙ„ Ø¹", "8": "Ø«Ø§Ù†ÙŠ Ø¹", "9": "Ø«Ø§Ù„Ø« Ø¹" };

        function showLoader() { document.getElementById('global-loader').style.display = 'flex'; }
        function hideLoader() { document.getElementById('global-loader').style.display = 'none'; }

        // Auth Logic
        auth.onAuthStateChanged((user) => {
            if (user) { document.getElementById('login-overlay').style.display = 'none'; document.getElementById('admin-panel').style.display = 'block'; loadSettings(); } 
            else { document.getElementById('login-overlay').style.display = 'flex'; document.getElementById('admin-panel').style.display = 'none'; }
        });
        function adminLogin() {
            const email = document.getElementById('adm-email').value; const pass = document.getElementById('adm-pass').value;
            showLoader(); auth.signInWithEmailAndPassword(email, pass).then(() => { Swal.fire('ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„','','success'); }).catch((e) => { Swal.fire('Ø®Ø·Ø£','Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©','error'); }).finally(() => hideLoader());
        }
        function adminLogout() { auth.signOut().then(() => location.reload()); }
        
        // Tab Switching & Initialization
        function showTab(id) { 
            document.querySelectorAll('.admin-tab').forEach(t => t.style.display = 'none'); 
            document.getElementById(id).style.display = 'block'; 
            if(id === 'tab-q') loadExamsToSelect('target-exam-select');
            if(id === 'tab-create-exam') loadExamsList();
            if(id === 'tab-posts') { loadManagePosts(); loadExamsToSelect('post-attach-id'); }
        }

        // --- 1. Exams ---
        function createExam(){
            const title = document.getElementById('exam-title').value;
            const grade = document.getElementById('exam-grade').value;
            const subject = document.getElementById('exam-subject').value;
            const category = document.getElementById('exam-category').value;
            if(!title || !category) return Swal.fire('Ø®Ø·Ø£','Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','error');
            
            db.collection('exams').add({ title, grade, subject, category, createdAt: new Date().toISOString() })
              .then(()=>{ Swal.fire('ØªÙ…','','success'); loadExamsList(); });
        }
        function loadExamsList(){
            db.collection('exams').orderBy('createdAt','desc').limit(5).get().then(snap=>{
                const div = document.getElementById('exams-list-preview'); div.innerHTML='';
                snap.forEach(doc=>{ div.innerHTML += `<div>- ${doc.data().title}</div>`; });
            });
        }

        // --- 2. Questions ---
        function loadExamsToSelect(elementId){
            const sel = document.getElementById(elementId);
            sel.innerHTML = '<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>';
            db.collection('exams').orderBy('createdAt','desc').get().then(snap=>{
                sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† --</option>';
                snap.forEach(doc=>{
                    const e = doc.data();
                    const opt = document.createElement('option');
                    opt.value = doc.id;
                    opt.innerText = `${e.title} (${e.grade} - ${e.category})`;
                    sel.appendChild(opt);
                });
            });
        }
        function loadExamQuestionsCount(){
            const id = document.getElementById('target-exam-select').value;
            if(!id) return;
            db.collection('questions').where('examId','==',id).get().then(snap=>{
                document.getElementById('exam-q-info').innerText = `Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${snap.size}`;
            });
        }
        function addQuestionToExam(){
            const examId = document.getElementById('target-exam-select').value;
            if(!examId) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†','warning');
            db.collection('questions').add({
                examId: examId, q: document.getElementById('q-text').value, c: document.getElementById('q-c').value,
                w: [document.getElementById('q-w1').value, document.getElementById('q-w2').value, "Ø®Ø·Ø£"]
            }).then(()=>{ Swal.fire('ØªÙ…','','success'); document.getElementById('q-text').value=''; loadExamQuestionsCount(); });
        }
        function addBulkQuestions(){
            const examId = document.getElementById('target-exam-select').value;
            if(!examId) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†','warning');
            try {
                const data = JSON.parse(document.getElementById('in-bulk').value);
                const batch = db.batch();
                data.forEach(item => { const ref = db.collection('questions').doc(); batch.set(ref, { ...item, examId: examId }); });
                batch.commit().then(()=>{ Swal.fire('ØªÙ… Ø§Ù„Ø±ÙØ¹','','success'); loadExamQuestionsCount(); });
            } catch(e) { Swal.fire('Ø®Ø·Ø£ JSON','','error'); }
        }

        // --- 3. MERGE & CLONE (NEW FEATURE) ---
        function loadExamsForMerge() {
            const grade = document.getElementById('merge-grade').value;
            const subject = document.getElementById('merge-subject').value;
            const list = document.getElementById('merge-list');
            if(!grade || !subject) return;
            
            list.innerHTML = '<div class="spinner"></div>';
            db.collection('exams').where('grade', '==', grade).where('subject', '==', subject).get().then(snap => {
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<p style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</p>'; return; }
                snap.forEach(doc => {
                    const e = doc.data();
                    list.innerHTML += `
                    <div class="check-list-item">
                        <input type="checkbox" class="merge-chk" value="${doc.id}">
                        <span><b>${e.title}</b> <small style="color:#888;">(${e.category})</small></span>
                    </div>`;
                });
            });
        }
        async function executeMerge() {
            const checks = document.querySelectorAll('.merge-chk:checked');
            const newTitle = document.getElementById('new-merge-title').value;
            const newCat = document.getElementById('new-merge-category').value;
            const grade = document.getElementById('merge-grade').value;
            const subject = document.getElementById('merge-subject').value;

            if(checks.length === 0 || !newTitle || !newCat) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ø®ØªØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ¶Ø¹ Ø¹Ù†ÙˆØ§Ù†Ø§Ù‹ ÙˆØªØµÙ†ÙŠÙØ§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹', 'warning');

            showLoader();
            try {
                // 1. Create New Exam
                const newExamRef = await db.collection('exams').add({
                    title: newTitle, grade, subject, category: newCat, createdAt: new Date().toISOString(), isMerged: true
                });

                // 2. Clone Questions
                const batch = db.batch();
                let count = 0;
                
                for (const chk of checks) {
                    const qSnap = await db.collection('questions').where('examId', '==', chk.value).get();
                    qSnap.forEach(qDoc => {
                        const qData = qDoc.data();
                        const newQRef = db.collection('questions').doc();
                        batch.set(newQRef, { ...qData, examId: newExamRef.id });
                        count++;
                    });
                }
                
                await batch.commit();
                hideLoader();
                Swal.fire('Ù†Ø¬Ø§Ø­', `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ "${newTitle}" ÙˆÙ†Ø³Ø® ${count} Ø³Ø¤Ø§Ù„ Ø¥Ù„ÙŠÙ‡ Ø¨Ù†Ø¬Ø§Ø­.`, 'success');
                document.getElementById('new-merge-title').value = '';
                checks.forEach(c => c.checked = false);
            } catch(e) {
                hideLoader();
                console.error(e);
                Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'error');
            }
        }

        // --- 4 & 5. Lessons & Videos (Updated for Global Content) ---
        function saveLesson() { 
            db.collection("lessons").add({ 
                grade: document.getElementById('in-l-grade').value, 
                title: document.getElementById('in-l-tit').value, 
                body: document.getElementById('in-l-bod').value, 
                img: document.getElementById('in-l-img').value 
            }).then(() => Swal.fire('ØªÙ… Ø§Ù„Ù†Ø´Ø±', '', 'success')); 
        }
        function saveVideo() { 
            db.collection("videos").add({ 
                grade: document.getElementById('in-v-grade').value, 
                title: document.getElementById('v-tit').value, 
                url: document.getElementById('v-url').value 
            }).then(() => Swal.fire('ØªÙ… Ø§Ù„Ù†Ø´Ø±', '', 'success')); 
        }

        // --- 6. TEACHER POSTS (NEW FEATURE) ---
        function togglePostAttach(){
            const type = document.getElementById('post-attach-type').value;
            const sel = document.getElementById('post-attach-id');
            sel.style.display = type === 'none' ? 'none' : 'block';
            sel.innerHTML = '<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>';
            
            if(type === 'exam') {
                loadExamsToSelect('post-attach-id');
            } else if (type === 'lesson') {
                db.collection('lessons').orderBy('title').get().then(snap => {
                    sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±Ø³ --</option>';
                    snap.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.id; opt.innerText = d.data().title;
                        sel.appendChild(opt);
                    });
                });
            }
        }
        function createPost() {
            const title = document.getElementById('post-title').value;
            const body = document.getElementById('post-body').value;
            const img = document.getElementById('post-img').value;
            const attType = document.getElementById('post-attach-type').value;
            const attId = document.getElementById('post-attach-id').value;

            if(!title) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ¬Ø¨ ÙˆØ¶Ø¹ Ø¹Ù†ÙˆØ§Ù† Ù„Ù„Ù…Ù†Ø´ÙˆØ±', 'warning');

            db.collection('posts').add({
                title, body, img,
                attachType: attType, attachId: attId,
                date: new Date().toISOString()
            }).then(() => {
                Swal.fire('ØªÙ…', 'ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±', 'success');
                document.getElementById('post-title').value = '';
                document.getElementById('post-body').value = '';
                loadManagePosts();
            });
        }
        function loadManagePosts() {
            const div = document.getElementById('posts-list-manage');
            div.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            db.collection('posts').orderBy('date', 'desc').get().then(snap => {
                div.innerHTML = '';
                if(snap.empty) div.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª</p>';
                snap.forEach(doc => {
                    const p = doc.data();
                    div.innerHTML += `<div style="padding:10px; border:1px solid #eee; margin-bottom:5px; border-radius:10px; background:#fff; display:flex; justify-content:space-between;">
                        <div><b>${p.title}</b> <small>${new Date(p.date).toLocaleDateString()}</small></div>
                        <button class="btn-del" onclick="db.collection('posts').doc('${doc.id}').delete().then(()=>loadManagePosts())">Ø­Ø°Ù</button>
                    </div>`;
                });
            });
        }

        // --- 7. Manage Content (Updated: Filter & Deep Edit) ---
        let manageCache = [];
        function loadManageExams() {
            const list = document.getElementById('mng-list');
            list.innerHTML = '<div class="spinner"></div>';
            db.collection('exams').orderBy('createdAt', 'desc').get().then(snap => {
                manageCache = [];
                snap.forEach(d => manageCache.push({id: d.id, ...d.data(), type: 'exam'}));
                renderManageList(manageCache);
            });
        }
        function loadManageData(coll, btn) {
            if(btn) { document.querySelectorAll('.manage-filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            const list = document.getElementById('mng-list');
            list.innerHTML = '<div class="spinner"></div>';
            db.collection(coll).get().then(snap => {
                manageCache = [];
                snap.forEach(d => manageCache.push({id: d.id, ...d.data(), type: coll}));
                renderManageList(manageCache);
            });
        }
        function renderManageList(items) {
            const list = document.getElementById('mng-list');
            if(items.length === 0) { list.innerHTML = '<p style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰</p>'; return; }
            list.innerHTML = items.map(i => {
                if(i.type === 'exam') {
                    return `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                        <div><b>${i.title}</b> <span style="font-size:12px; color:#888;">(${i.grade} - ${i.category})</span></div>
                        <div>
                            <button class="btn-edit" onclick="openDeepEdit('${i.id}')">ØªØ¹Ø¯ÙŠÙ„ Ø´Ø§Ù…Ù„</button>
                            <button class="btn-del" onclick="deleteExamFinal('${i.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                } else {
                    return `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                        <div><b>${i.title}</b> <span style="font-size:12px; color:#888;">(${i.grade === 'all' ? 'Ø¹Ø§Ù…' : i.grade})</span></div>
                        <div>
                            <button class="btn-edit" onclick="openSimpleEdit('${i.id}', '${i.type}s', '${i.grade}')"><i class="fas fa-pen"></i></button>
                            <button class="btn-del" onclick="delDoc('${i.type}s', '${i.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                }
            }).join('');
        }
        function filterManageList() {
            const term = document.getElementById('search-mng').value.toLowerCase();
            const filtered = manageCache.filter(i => i.title.toLowerCase().includes(term));
            renderManageList(filtered);
        }
        function delDoc(c, id) { if(confirm("Ø­Ø°ÙØŸ")) db.collection(c).doc(id).delete().then(() => loadManageData(c)); }
        function deleteExamFinal(id) {
            if(!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙˆÙƒÙ„ Ø£Ø³Ø¦Ù„ØªÙ‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
            db.collection('questions').where('examId','==',id).get().then(snap => {
                const batch = db.batch();
                snap.forEach(d => batch.delete(d.ref));
                batch.delete(db.collection('exams').doc(id));
                batch.commit().then(() => { Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù'); loadManageExams(); });
            });
        }
        
        // Simple Edit (Lessons/Videos)
        function openSimpleEdit(id, c, g) { 
            document.getElementById('edit-id').value = id; document.getElementById('edit-col').value = c; 
            document.getElementById('edit-grade').value = g; document.getElementById('modal-edit').style.display = 'flex'; 
        }
        function saveEdit() { 
            const id = document.getElementById('edit-id').value; const col = document.getElementById('edit-col').value; 
            db.collection(col).doc(id).update({ grade: document.getElementById('edit-grade').value })
              .then(() => { document.getElementById('modal-edit').style.display = 'none'; Swal.fire('ØªÙ…'); loadManageData(col); }); 
        }

        // Deep Edit (Exams - NEW FEATURE)
        let currentEditingExamId = null;
        function openDeepEdit(id) {
            currentEditingExamId = id;
            showLoader();
            const exam = manageCache.find(e => e.id === id);
            
            document.getElementById('deep-edit-id').value = id;
            document.getElementById('deep-tit').value = exam.title;
            document.getElementById('deep-grade').value = exam.grade;
            document.getElementById('deep-cat').value = exam.category;
            
            db.collection('questions').where('examId', '==', id).get().then(snap => {
                const list = document.getElementById('deep-q-list');
                document.getElementById('deep-q-count').innerText = snap.size;
                list.innerHTML = '';
                snap.forEach(qDoc => {
                    const q = qDoc.data();
                    list.innerHTML += `
                    <div style="background:#fff; border:1px solid #ddd; padding:10px; margin-bottom:5px; border-radius:5px;">
                        <input id="q-txt-${qDoc.id}" value="${q.q}" style="margin-bottom:5px;">
                        <div style="display:flex; gap:5px;">
                            <button class="btn-edit" onclick="updateQuestionText('${qDoc.id}')">Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
                            <button class="btn-del" onclick="deleteQuestionOne('${qDoc.id}')">Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„</button>
                        </div>
                    </div>`;
                });
                document.getElementById('modal-deep-edit').style.display = 'flex';
                hideLoader();
            });
        }
        function saveDeepExamInfo() {
            const id = document.getElementById('deep-edit-id').value;
            db.collection('exams').doc(id).update({
                title: document.getElementById('deep-tit').value,
                grade: document.getElementById('deep-grade').value,
                category: document.getElementById('deep-cat').value
            }).then(() => { Swal.fire('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©'); loadManageExams(); });
        }
        function updateQuestionText(qid) {
            const val = document.getElementById(`q-txt-${qid}`).value;
            db.collection('questions').doc(qid).update({ q: val }).then(() => Swal.fire({toast:true, icon:'success', title:'ØªÙ… Ø§Ù„Ø­ÙØ¸', showConfirmButton:false, timer:1000}));
        }
        function deleteQuestionOne(qid) {
            if(confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ')) {
                db.collection('questions').doc(qid).delete().then(() => {
                    document.getElementById(`q-txt-${qid}`).parentElement.remove();
                    let count = Number(document.getElementById('deep-q-count').innerText);
                    document.getElementById('deep-q-count').innerText = count - 1;
                });
            }
        }

        // --- Other Features (Messages, Users, etc. - UNTOUCHED) ---
        function loadMessagesList(){
            db.collection('messages').orderBy('lastTime','desc').limit(20).onSnapshot(snap=>{
                const l = document.getElementById('msg-list'); l.innerHTML = '';
                snap.forEach(doc=>{ const d = doc.data(); l.innerHTML += `<div class="chat-list-item" onclick="openChat('${doc.id}','${d.studentName}')" style="background:${d.unread?'#f0f9ff':'white'}"><div><b>${d.studentName}</b></div>${d.unread?'<span style="color:red">â—</span>':''}</div>`; });
            });
        }
        let selectedChatUid = null;
        function openChat(uid, name){
            selectedChatUid = uid; document.getElementById('msg-view').style.display='flex'; document.getElementById('chat-header').innerText = name;
            db.collection('messages').doc(uid).update({unread:false});
            db.collection('messages').doc(uid).collection('chat').orderBy('timestamp').onSnapshot(snap=>{
                const box = document.getElementById('admin-chat-box'); box.innerHTML='';
                snap.forEach(d=>{ const m=d.data(); box.innerHTML+=`<div class="${m.sender==='admin'?'adm-msg':'stu-msg'}">${m.text}</div>`; });
                box.scrollTop=box.scrollHeight;
            });
        }
        function sendReply(){ const t=document.getElementById('adm-reply-inp').value; if(t && selectedChatUid) { db.collection('messages').doc(selectedChatUid).collection('chat').add({text:t, sender:'admin', timestamp:new Date().toISOString()}); document.getElementById('adm-reply-inp').value=''; } }
        
        function loadStudents(){
            const tb = document.getElementById('users-body'); tb.innerHTML = '<tr><td colspan="4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            db.collection('users').limit(50).get().then(snap=>{
                tb.innerHTML = '';
                snap.forEach(d=>{ const u = d.data(); tb.innerHTML += `<tr><td>${u.name}</td><td>${u.grade}</td><td>${u.email}</td><td><button class="btn-del" onclick="if(confirm('Ø­Ø°ÙØŸ')) db.collection('users').doc('${d.id}').delete().then(()=>loadStudents())">Ø­Ø°Ù</button></td></tr>`; });
            });
        }
        
        function createRule(){
            const t=document.getElementById('badge-title').value; const i=document.getElementById('badge-icon').value; const c=document.getElementById('badge-cond').value; const th=Number(document.getElementById('badge-thresh').value);
            db.collection('badges_rules').add({title:t, icon:i, condition:c, threshold:th, type:'auto', color:'gold'}).then(()=>{ Swal.fire('ØªÙ…'); loadBadgeRules(); });
        }
        function loadBadgeRules(){
            const l=document.getElementById('rules-list'); l.innerHTML='';
            db.collection('badges_rules').get().then(s=>{ s.forEach(d=>{ l.innerHTML+=`<div>${d.data().title} <button class="btn-del" onclick="db.collection('badges_rules').doc('${d.id}').delete().then(()=>loadBadgeRules())">x</button></div>`; }); });
        }
        
        function loadPubComments(){
            db.collection('public_comments').orderBy('time','desc').limit(20).onSnapshot(s=>{
                document.getElementById('adm-pub-list').innerHTML = s.docs.map(d=>{
                    return `<div style="border:1px solid #eee; padding:10px; margin-bottom:5px;"><b>${d.data().name}</b>: ${d.data().text} <div style="margin-top:5px;"><input id="rep-${d.id}" placeholder="Ø±Ø¯..." style="width:60%; display:inline-block;"><button onclick="db.collection('public_comments').doc('${d.id}').update({reply:document.getElementById('rep-${d.id}').value})" class="btn-sec">Ø±Ø¯</button> <button class="btn-del" onclick="db.collection('public_comments').doc('${d.id}').delete()">Ø­Ø°Ù</button></div></div>`;
                }).join('');
            });
        }
        
        function loadStudentResults() { const tbody = document.getElementById('results-body'); tbody.innerHTML = '<tr><td colspan="6">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>'; db.collection("results").orderBy('date','desc').limit(50).get().then(snap => { const docs = snap.docs.map(d=>({id:d.id,...d.data()})); tbody.innerHTML = docs.map(r => `<tr><td>${new Date(r.date).toLocaleDateString()}</td><td>${r.name}</td><td>${r.grade}</td><td>${r.examType}</td><td>${r.score}/${r.total}</td><td><button class="btn-small-danger" onclick="db.collection('results').doc('${r.id}').delete().then(()=>loadStudentResults())">Ø­Ø°Ù</button></td></tr>`).join(''); }); }
        function clearResults() { if(confirm("Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ")) { db.collection("results").get().then(snap => { const batch = db.batch(); snap.forEach(d => batch.delete(d.ref)); batch.commit().then(() => loadStudentResults()); }); } }
        
        function loadSettings() { db.collection("settings").doc("site_info").get().then(s => { if(s.exists) { const d = s.data(); document.getElementById('set-title').value = d.title||""; document.getElementById('set-logo').value = d.logo||""; document.getElementById('set-desc').value = d.description||""; document.getElementById('set-wa').value = d.wa||""; document.getElementById('set-tele').value = d.tele||""; document.getElementById('set-face').value = d.face||""; document.getElementById('set-tiktok').value = d.tiktok||""; } }); }
        function saveSiteSettings() { db.collection("settings").doc("site_info").set({ title: document.getElementById('set-title').value, logo: document.getElementById('set-logo').value, description: document.getElementById('set-desc').value, wa: document.getElementById('set-wa').value, tele: document.getElementById('set-tele').value, face: document.getElementById('set-face').value, tiktok: document.getElementById('set-tiktok').value }, {merge: true}).then(() => Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸', '', 'success')); }
  </script> 
 
</body></html>