<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØµØ© Ù„ØºØªÙŠ Ù‡ÙˆÙŠØªÙŠ - Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        :root {
            --main: #4a90e2; --sec: #2ecc71; --vocab: #9b59b6;
            --video: #e67e22; --err: #e74c3c; --bg: #f8fafc;
            --white: #ffffff; --text: #334155; --dark: #1e293b;
        }
        * { box-sizing: border-box; transition: 0.2s; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 20px; min-height: 100vh; }

        .container {
            width: 100%; max-width: 1100px; background: var(--white);
            border-radius: 20px; padding: 30px; margin: 0 auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        h2, h3, h4 { color: var(--dark); font-weight: 800; margin-top: 0; }
        h2 { border-right: 5px solid var(--main); padding-right: 15px; color: var(--main); }

        /* Form Elements */
        label { font-weight: bold; font-size: 14px; color: #64748b; margin-bottom: 5px; display: block; }
        input, select, textarea {
            width: 100%; padding: 12px 15px; margin: 5px 0 15px 0;
            border: 1px solid #e2e8f0; border-radius: 10px;
            font-size: 14px; outline: none; display: block; background: #f8fafc;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--main); background: #fff; box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1); }

        /* Buttons */
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; margin-bottom: 10px; color: white; font-size: 15px; display: inline-flex; justify-content: center; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.15); }
        .btn-main { background: linear-gradient(135deg, #4a90e2, #3b82f6); }
        .btn-sec { background: linear-gradient(135deg, #2ecc71, #22c55e); }
        .btn-video { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-posts { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .btn-users { background: linear-gradient(135deg, #ec4899, #db2777); }
        
        .btn-del { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; width: auto; padding: 6px 12px; font-size: 12px; border-radius: 6px; cursor: pointer; }
        .btn-edit { background: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; width: auto; padding: 6px 12px; font-size: 12px; margin-left: 5px; border-radius: 6px; cursor: pointer; }
        .btn-report { background: #e0e7ff; color: #6366f1; border: 1px solid #c7d2fe; width: auto; padding: 6px 12px; font-size: 12px; margin-left: 5px; border-radius: 6px; cursor: pointer; }
        .btn-outline { background: #fff; border: 2px solid #e2e8f0; color: #64748b; box-shadow: none; }
        .btn-outline:hover { border-color: var(--main); color: var(--main); }
        .btn-small-danger { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; width: auto; padding: 6px 12px; font-size: 12px; border-radius: 6px; cursor: pointer; }

        /* Navigation */
        .admin-nav { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; }
        .admin-nav button { margin: 0; height: 50px; font-size: 13px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; line-height: 1.2; }
        .admin-nav button i { font-size: 16px; margin-bottom: 2px; }

        .admin-tab { display: none; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards & Containers in Admin */
        .admin-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .admin-card h3 { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; font-size: 18px; display: flex; align-items: center; gap: 10px; }

        /* Login */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f1f5f9; z-index: 10000; display: flex; justify-content: center; align-items: center; }
        #login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }

        /* Tables */
        .table-container { overflow-x: auto; border-radius: 10px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 12px 15px; text-align: center; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        th { background: #f8fafc; color: var(--dark); font-weight: 700; white-space: nowrap; }
        tr:last-child td { border-bottom: none; }

        /* Loader */
        #global-loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 30000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .spinner { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top-color: var(--main); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to {transform: rotate(360deg);} }

        /* Merge Checkboxes - Enhanced */
        .search-container { position: relative; margin-bottom: 10px; }
        .search-icon { position: absolute; left: 15px; top: 12px; color: #94a3b8; }
        #exam-search-input { padding-left: 35px; border-color: #fed7aa; background: #fff; }
        #exam-search-input:focus { border-color: #ea580c; box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1); }
        
        .check-exam-box { 
            padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; 
            cursor: pointer; transition: 0.2s; 
        }
        .check-exam-box:hover { background: #fff7ed; }
        .check-exam-box input[type="checkbox"] { width: 18px; height: 18px; margin: 0; cursor: pointer; accent-color: #ea580c; }
        .check-exam-box span { font-size: 14px; color: #334155; }
        .check-exam-box small { color: #94a3b8; display: block; font-size: 11px; margin-top: 2px; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 20000; justify-content: center; align-items: center; padding: 15px; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 100%; max-width: 600px; border-radius: 20px; padding: 25px; position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-close { position: absolute; left: 20px; top: 20px; font-size: 25px; cursor: pointer; color: #94a3b8; }
        .modal-close:hover { color: var(--err); }
        
        .manage-filter-bar { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .manage-filter-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid #e2e8f0; background: white; cursor: pointer; font-size: 13px; font-weight: 600; color: #64748b; }
        .manage-filter-btn.active { background: var(--main); color: white; border-color: var(--main); }

        /* Report Styles */
        .report-header { text-align: center; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; margin-bottom: 20px; }
        .report-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-box { background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; }
        .stat-box h4 { margin: 0; color: #64748b; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-box p { margin: 10px 0 0; font-weight: 900; font-size: 24px; color: var(--dark); }
    </style>
</head>
<body>
    <div id="global-loader">
        <div class="spinner"></div>
    </div>

    <div id="login-overlay">
        <div id="login-box">
            <img src="https://cdn-icons-png.flaticon.com/512/3426/3426653.png" width="80" style="margin-bottom:20px;">
            <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            <input type="email" id="adm-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="adm-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn btn-main" onclick="adminLogin()">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
        </div>
    </div>

    <div class="container" id="admin-panel" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <img src="https://cdn-icons-png.flaticon.com/512/3426/3426653.png" width="50">
                <div>
                    <h2 style="border:none; padding:0; margin:0;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                    <span style="font-size: 13px; color: #64748b;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ø·Ù„Ø§Ø¨</span>
                </div>
            </div>
            <a href="index.html" target="_blank" class="btn btn-outline" style="width: auto; padding: 8px 20px; margin:0;">Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø·Ø§Ù„Ø¨ <i class="fas fa-external-link-alt" style="margin-right:5px;"></i></a>
        </div>

        <div class="admin-nav">
            <button class="btn-outline active-nav" onclick="showTab('tab-create-exam', this)"><i class="fas fa-file-signature"></i> Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</button>
            <button class="btn-outline" onclick="showTab('tab-q', this)"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø©</button>
            <button class="btn-outline" onclick="showTab('tab-l', this)"><i class="fas fa-book"></i> Ø§Ù„Ø¯Ø±ÙˆØ³</button>
            <button class="btn-outline" onclick="showTab('tab-v', this)"><i class="fas fa-video"></i> Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</button>
            <button class="btn-outline" onclick="showTab('tab-posts', this); loadExamsForPosts();"><i class="fas fa-newspaper"></i> Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</button>
            <button class="btn-outline" onclick="showTab('tab-mng', this); loadManageData('all');"><i class="fas fa-tasks"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰</button>
            <button class="btn-outline" onclick="showTab('tab-users', this); loadStudents();"><i class="fas fa-users"></i> Ø§Ù„Ø·Ù„Ø§Ø¨</button>
            <button class="btn-outline" onclick="showTab('tab-rules', this); loadBadgeRules();"><i class="fas fa-medal"></i> Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</button>
            <button class="btn-outline" onclick="showTab('tab-results', this); loadStudentResults();"><i class="fas fa-chart-bar"></i> Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
            <button class="btn-outline" onclick="showTab('tab-settings', this)"><i class="fas fa-cogs"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button class="btn-outline" onclick="adminLogout()" style="color:#ef4444; border-color:#fee2e2;"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
        </div>

        <div id="tab-create-exam" class="admin-tab" style="display: block;">
            
            <div class="admin-card">
                <h3 style="color:var(--main);"><i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù…ØªØ­Ø§Ù† Ø¬Ø¯ÙŠØ¯</h3>
                <div style="background: #f8fafc; padding: 20px; border-radius: 10px; border: 1px solid #e2e8f0;">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:</label>
                    <input id="exam-title" placeholder="Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù‡Ù†Ø§...">
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-bottom: 15px;">
                        <div>
                            <label>Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</label>
                            <select id="exam-grade">
                                <option value="all">Ø§Ù„Ø¬Ù…ÙŠØ¹ (ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„)</option>
                                <option value="4">4 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="5">5 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="6">6 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                <option value="7">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="8">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="9">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                            </select>
                        </div>
                        <div>
                            <label>Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
                            <select id="exam-subject">
                                <option value="grammar">Ù†Ø­Ùˆ</option>
                                <option value="vocab">Ù…ÙØ±Ø¯Ø§Øª</option>
                            </select>
                        </div>
                        <div>
                            <label>Ø§Ù„ØªØµÙ†ÙŠÙ (Ø§Ù„Ù…Ø¬Ù„Ø¯):</label>
                            <select id="exam-category">
                                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ --</option>
                                <option value="Ø£Ø³Ø¨ÙˆØ¹ÙŠ">ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</option>
                                <option value="Ø´Ø§Ù…Ù„">Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø´Ø§Ù…Ù„Ø©</option>
                                <option value="ØªØ±Ù…1">ØªØ±Ù… Ø£ÙˆÙ„</option>
                                <option value="ØªØ±Ù…2">ØªØ±Ù… Ø«Ø§Ù†ÙŠ</option>
                                <option value="Ø£ÙƒØªÙˆØ¨Ø±">Ø£ÙƒØªÙˆØ¨Ø±</option>
                                <option value="Ù†ÙˆÙÙ…Ø¨Ø±">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                                <option value="Ø¯ÙŠØ³Ù…Ø¨Ø±">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                                <option value="ÙØ¨Ø±Ø§ÙŠØ±">ÙØ¨Ø±Ø§ÙŠØ±</option>
                                <option value="Ù…Ø§Ø±Ø³">Ù…Ø§Ø±Ø³</option>
                                <option value="Ø£Ø¨Ø±ÙŠÙ„">Ø£Ø¨Ø±ÙŠÙ„</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-main" onclick="createExam()" style="width: 200px; float: left; margin-top: 10px;">
                        <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
                    </button>
                    <div style="clear:both;"></div>
                </div>
            </div>

            <div class="admin-card" style="border-left: 5px solid #ea580c; border-right: 1px solid #fed7aa; border-top: 1px solid #fed7aa; border-bottom: 1px solid #fed7aa;">
                <h3 style="color:#ea580c; margin-top:0;"><i class="fas fa-random"></i> Ø¯Ù…Ø¬ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª (Ù†Ø³Ø® Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ø¹Ø¯Ø© Ø§Ù…ØªØ­Ø§Ù†Ø§Øª)</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px;">
                    <div>
                        <label style="color:#ea580c;">1. Ø§Ø¨Ø­Ø« ÙˆØ§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª (Ù…ØªØ¹Ø¯Ø¯):</label>
                        
                        <div class="search-container">
                            <input type="text" id="exam-search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†..." onkeyup="filterMergeList()">
                            <i class="fas fa-search search-icon"></i>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-size: 12px; color: #64748b;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ: <span id="selected-count" style="font-weight: bold; color: #ea580c;">0</span></span>
                            <div>
                                <button class="btn-outline" style="font-size: 11px; padding: 2px 8px; height: auto;" onclick="selectAllVisible()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶</button>
                                <button class="btn-outline" style="font-size: 11px; padding: 2px 8px; height: auto; color:#ef4444; border-color:#fee2e2;" onclick="clearAllSelection()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</button>
                            </div>
                        </div>

                        <div id="merge-source-list" style="height: 250px; overflow-y: auto; background: #fff; border: 1px solid #fed7aa; border-radius: 8px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="padding:20px; text-align:center; color:#999;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                        </div>
                    </div>

                    <div style="background: #fff7ed; padding: 20px; border-radius: 10px; height: fit-content;">
                        <label style="color:#ea580c;">2. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
                        <input id="merge-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯...">
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                            <div>
                                <label>Ø§Ù„ØµÙ:</label>
                                <select id="merge-grade">
                                    <option value="all">Ø§Ù„Ø¬Ù…ÙŠØ¹</option>
                                    <option value="4">4 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="5">5 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="6">6 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                    <option value="7">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="8">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="9">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                                </select>
                            </div>
                            <div>
                                <label>Ø§Ù„ØªØµÙ†ÙŠÙ:</label>
                                <select id="merge-category">
                                    <option value="Ø´Ø§Ù…Ù„">Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø´Ø§Ù…Ù„Ø©</option>
                                    <option value="ØªØ±Ù…1">ØªØ±Ù… Ø£ÙˆÙ„</option>
                                    <option value="ØªØ±Ù…2">ØªØ±Ù… Ø«Ø§Ù†ÙŠ</option>
                                    <option value="Ø£Ø³Ø¨ÙˆØ¹ÙŠ">ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-video" onclick="mergeExams()" style="margin-top: 15px; width: 100%;">
                            <i class="fas fa-cogs"></i> Ø¯Ù…Ø¬ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
                        </button>
                    </div>
                </div>
            </div>

            <div class="admin-card">
                <h3><i class="fas fa-list"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                <div id="exams-list" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <div id="tab-q" class="admin-tab">
            <div class="admin-card">
                <h3><i class="fas fa-question-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ø­Ø¯Ø¯</h3>
                <label style="color:#ef4444;">1. Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø°ÙŠ Ø³ØªØ¶ÙŠÙ ÙÙŠÙ‡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
                <select id="target-exam-select" onchange="loadExamQuestionsCount()" style="border: 2px solid #e2e8f0;">
                    <option value="">-- Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„... --</option>
                </select>
                <div id="exam-q-info" style="color:#16a34a; font-weight:bold; margin-bottom:15px; padding:10px; background:#dcfce7; border-radius:8px; display:inline-block;"></div>
            </div>
            <div class="admin-card">
                <h3>Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯</h3>
                <input id="q-text" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„">
                <input id="q-c" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©" style="border-color:#86efac;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input id="q-w1" placeholder="Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© 1" style="border-color:#fca5a5;">
                    <input id="q-w2" placeholder="Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø© 2" style="border-color:#fca5a5;">
                </div>
                <button class="btn btn-sec" onclick="addQuestionToExam()">Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
            </div>
            <div class="admin-card" style="background:#f8fafc;">
                <h3>ğŸš€ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø¬Ù…Ø¹ (JSON)</h3>
                <textarea id="in-bulk" rows="4" placeholder="[{&quot;q&quot;:&quot;Ø³Ø¤Ø§Ù„&quot;,&quot;c&quot;:&quot;ØµØ­&quot;,&quot;w&quot;:[&quot;Ø®Ø·Ø£1&quot;,&quot;Ø®Ø·Ø£2&quot;]}]"></textarea>
                <button class="btn btn-main" onclick="addBulkQuestions()">Ø±ÙØ¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
            </div>
        </div>

        <div id="tab-l" class="admin-tab">
            <div class="admin-card">
                <h3><i class="fas fa-book-open"></i> Ù†Ø´Ø± Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯</h3>
                <select id="in-l-grade">
                    <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option>
                    <option value="4">4 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="5">5 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="6">6 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="7">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="8">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="9">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                </select>
                <input id="in-l-tit" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³">
                <textarea id="in-l-bod" rows="8" placeholder="Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø´Ø±Ø­..."></textarea>
                <input id="in-l-img" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                <button class="btn btn-sec" onclick="saveLesson()">Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³</button>
            </div>
        </div>

        <div id="tab-v" class="admin-tab">
            <div class="admin-card">
                <h3><i class="fas fa-video"></i> Ù†Ø´Ø± ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯</h3>
                <select id="in-v-grade">
                    <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option>
                    <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                    <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                </select>
                <input id="v-tit" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ">
                <input id="v-url" placeholder="Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ Ø£Ùˆ ØªÙŠÙƒ ØªÙˆÙƒ">
                <button class="btn btn-video" onclick="saveVideo()">Ù†Ø´Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
            </div>
        </div>

        <div id="tab-posts" class="admin-tab">
            <div class="admin-card" style="border-color:#e9d5ff;">
                <h3 style="color:#7e22ce;"><i class="fas fa-bullhorn"></i> Ù…Ù†Ø´ÙˆØ± / Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯ (Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª)</h3>
                <input id="post-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø± / Ø§Ù„Ù…Ù†Ø´ÙˆØ±">
                <textarea id="post-body" rows="4" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¨Ø±..."></textarea>
                <input id="post-img" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div>
                        <label>Ø¥Ø±ÙØ§Ù‚ Ø§Ù…ØªØ­Ø§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                        <select id="post-exam-select">
                            <option value="">-- Ø¨Ø¯ÙˆÙ† Ø§Ù…ØªØ­Ø§Ù† --</option>
                        </select>
                    </div>
                    <div>
                        <label>Ø§Ù„Ø¸Ù‡ÙˆØ±:</label>
                        <select id="post-grade">
                            <option value="all">Ù„Ù„Ø¬Ù…ÙŠØ¹ (Ø¹Ø§Ù…)</option>
                            <option value="4">4 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="5">5 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="6">6 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                            <option value="7">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="8">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="9">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-posts" onclick="createPost()">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
            </div>
            <div class="admin-card">
                <h4>Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h4>
                <div id="posts-list-manage"></div>
            </div>
        </div>

        <div id="tab-mng" class="admin-tab">
            <div class="admin-card">
                <h3>Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h3>
                <div class="manage-filter-bar">
                    <button class="manage-filter-btn active" onclick="loadManageData('all', this)">Ø§Ù„ÙƒÙ„</button>
                    <button class="manage-filter-btn" onclick="loadManageData('questions', this)">Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
                    <button class="manage-filter-btn" onclick="loadManageData('lessons', this)">Ø§Ù„Ø¯Ø±ÙˆØ³</button>
                    <button class="manage-filter-btn" onclick="loadManageData('videos', this)">Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</button>
                </div>
                <div id="mng-list" style="max-height:500px; overflow-y:auto; padding-right:5px;"></div>
            </div>
        </div>

        <div id="tab-users" class="admin-tab">
            <div class="admin-card">
                <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
                <div class="table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                <th>Ø§Ù„ØµÙ</th>
                                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                                <th style="min-width: 250px;">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="users-body">
                            <tr>
                                <td colspan="4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-rules" class="admin-tab">
            <div class="admin-card">
                <h3>Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</h3>
                <div style="background:#fffbe6; padding:15px; margin-bottom:15px; border-radius:10px; border:1px solid #ffe58f;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <input id="badge-title" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø© (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨)">
                        <input id="badge-icon" placeholder="ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (fas fa-star)">
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <select id="badge-cond"><option value="exams_count">Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</option><option value="perfect_score">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</option></select>
                        <input id="badge-thresh" type="number" placeholder="Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ù…Ø«Ù„Ø§Ù‹ 5)">
                    </div>
                    <button class="btn btn-main" onclick="createRule()">Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø¯Ø©</button>
                </div>
                <div id="rules-list"></div>
            </div>
        </div>

        <div id="tab-results" class="admin-tab">
            <div class="admin-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h3>
                    <button class="btn btn-del" style="width:auto;" onclick="clearResults()"><i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
                </div>
                <div class="table-container" style="margin-top:15px;">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                <th>Ø§Ù„ØµÙ</th>
                                <th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
                                <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                <th>Ø­Ø°Ù</th>
                            </tr>
                        </thead>
                        <tbody id="results-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-settings" class="admin-tab">
            <div class="admin-card">
                <h3><i class="fas fa-sliders-h"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØµØ©</h3>
                <label>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</label>
                <div style="background:#f0f9ff; padding:15px; border-radius:10px; border:1px solid #bae6fd; margin-bottom:20px;">
                    <input type="text" id="set-title" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØµØ©">
                    <input type="text" id="set-logo" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø± (Image URL)">
                    <textarea id="set-desc" rows="3" placeholder="ÙˆØµÙ ØªØ±Ø­ÙŠØ¨ÙŠ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©..."></textarea>
                </div>
                <label>ØªØ³Ù…ÙŠØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (ØªØ­ÙƒÙ… ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡):</label>
                <div style="background:#fdf4ff; padding:15px; border-radius:10px; border:1px solid #f0abfc; margin-bottom:20px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="text" id="lbl-grammar" placeholder="Ø§Ø³Ù… Ù‚Ø³Ù… Ø§Ù„Ù†Ø­Ùˆ (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„Ù†Ø­Ùˆ)">
                    <input type="text" id="lbl-vocab" placeholder="Ø§Ø³Ù… Ù‚Ø³Ù… Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª)">
                    <input type="text" id="lbl-lib" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø© (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„Ù…ÙƒØªØ¨Ø©)">
                    <input type="text" id="lbl-vid" placeholder="Ø§Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„ÙÙŠØ¯ÙŠÙˆ)">
                    <input type="text" id="lbl-posts" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª)">
                </div>
                <label>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„:</label>
                <div style="background:#fff1f2; padding:15px; border-radius:10px; border:1px solid #fecdd3; margin-bottom:20px;">
                    <input type="text" id="set-app-url" placeholder="Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚">
                </div>
                <label>Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ:</label>
                <div style="background:#f0fdf4; padding:15px; border-radius:10px; border:1px solid #bbf7d0; margin-bottom:20px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="text" id="set-wa" placeholder="Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨">
                    <input type="text" id="set-tele" placeholder="Ø±Ø§Ø¨Ø· ØªÙ„ÙŠØ¬Ø±Ø§Ù…">
                    <input type="text" id="set-face" placeholder="Ø±Ø§Ø¨Ø· ÙÙŠØ³Ø¨ÙˆÙƒ">
                    <input type="text" id="set-tiktok" placeholder="Ø±Ø§Ø¨Ø· ØªÙŠÙƒ ØªÙˆÙƒ">
                </div>
                <button class="btn btn-main" onclick="saveSiteSettings()">Ø­ÙØ¸ ÙƒØ§ÙØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>
        </div>
    </div>

    <div id="modal-edit" class="modal">
        <div class="modal-content">
            <span onclick="document.getElementById('modal-edit').style.display='none'" class="modal-close">Ã—</span>
            <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h3>
            <input type="hidden" id="edit-id">
            <input type="hidden" id="edit-col">
            <label>ØªØºÙŠÙŠØ± Ø§Ù„ØµÙ:</label>
            <select id="edit-grade"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option></select>
            <button class="btn btn-main" onclick="saveEdit()" style="margin-top:15px;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
    </div>

    <div id="modal-student-report" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span onclick="document.getElementById('modal-student-report').style.display='none'" class="modal-close">Ã—</span>
            <div id="report-content-area"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCgpj7MLByWpTVUE2Tg3DQ0pwsUjLhAyEM",
            authDomain: "ahmedead-5185c.firebaseapp.com",
            projectId: "ahmedead-5185c",
            storageBucket: "ahmedead-5185c.firebasestorage.app",
            messagingSenderId: "559908876854",
            appId: "1:559908876854:web:e8e7c151e984dc13219e97"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const gradeNames = { "all": "Ø§Ù„Ø¬Ù…ÙŠØ¹", "4": "Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "5": "Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "6": "Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "7": "Ø£ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "8": "Ø«Ø§Ù†ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "9": "Ø«Ø§Ù„Ø« Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ" };
        
        function showLoader() { document.getElementById('global-loader').style.display = 'flex'; }
        function hideLoader() { document.getElementById('global-loader').style.display = 'none'; }

        auth.onAuthStateChanged((user) => {
            if (user) { document.getElementById('login-overlay').style.display = 'none'; document.getElementById('admin-panel').style.display = 'block'; loadSettings(); }
            else { document.getElementById('login-overlay').style.display = 'flex'; document.getElementById('admin-panel').style.display = 'none'; }
        });

        function adminLogin() {
            const email = document.getElementById('adm-email').value; const pass = document.getElementById('adm-pass').value;
            showLoader(); auth.signInWithEmailAndPassword(email, pass).then(() => { Swal.fire({icon:'success', title:'ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„', timer:1500, showConfirmButton:false}); }).catch((e) => { Swal.fire({icon:'error', title:'Ø®Ø·Ø£', text:'ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'}); }).finally(() => hideLoader());
        }
        function adminLogout() { auth.signOut().then(() => location.reload()); }
        
        function showTab(id, btn) {
            document.querySelectorAll('.admin-tab').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.admin-nav button').forEach(b => b.classList.remove('active-nav'));
            document.querySelectorAll('.admin-nav button').forEach(b => b.style.borderColor = '#e2e8f0');
            document.querySelectorAll('.admin-nav button').forEach(b => b.style.color = '#64748b');

            document.getElementById(id).style.display = 'block';
            if(btn) { btn.style.borderColor = '#4a90e2'; btn.style.color = '#4a90e2'; }

            if(id === 'tab-q') loadExamsToSelect();
            if(id === 'tab-create-exam') { loadExamsList(); loadExamsForMergeList(); }
            if(id === 'tab-posts') loadPostsList();
        }

        // --- 1. Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø¯Ù…Ø¬ ---
        function createExam(){
            const title = document.getElementById('exam-title').value;
            const grade = document.getElementById('exam-grade').value;
            const subject = document.getElementById('exam-subject').value;
            const category = document.getElementById('exam-category').value;
            
            if(!title || !category) return Swal.fire('Ø®Ø·Ø£','Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','error');
            
            db.collection('exams').add({
                title, grade, subject, category, createdAt: new Date().toISOString()
            }).then(()=>{
                Swal.fire('ØªÙ…','ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­','success');
                loadExamsList(); loadExamsForMergeList();
            });
        }

        function loadExamsList(){
            const div = document.getElementById('exams-list'); div.innerHTML='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            db.collection('exams').orderBy('createdAt','desc').get().then(snap=>{
                div.innerHTML='';
                snap.forEach(doc=>{
                    const e = doc.data();
                    div.innerHTML += `<div style="background:#f8fafc; padding:12px; margin-bottom:8px; border-radius:8px; border:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                        <span><b>${e.title}</b> <small style="color:#64748b;">(${e.category} - ${gradeNames[e.grade]})</small></span>
                        <button class="btn-del" onclick="deleteExam('${doc.id}')"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
            });
        }
        function deleteExam(id){ if(confirm('Ø­Ø°Ù Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ØŸ')) db.collection('exams').doc(id).delete().then(()=>{ loadExamsList(); loadExamsForMergeList(); }); }

        // --- Ù…Ù†Ø·Ù‚ Ø¯Ù…Ø¬ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§) ---
        let allExamsCache = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
        let selectedExamIds = new Set(); // Ù…Ø®Ø²Ù† Ø¯Ø§Ø¦Ù… Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© (Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ø¨Ø­Ø«)

        function loadExamsForMergeList() {
            const list = document.getElementById('merge-source-list');
            list.innerHTML = '<div style="padding:10px;text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
            
            db.collection('exams').orderBy('createdAt', 'desc').get().then(snap => {
                allExamsCache = [];
                // Ù„Ø§ Ù†Ù‚ÙˆÙ… Ø¨ØªÙØ±ÙŠØº selectedExamIds Ù‡Ù†Ø§ Ù„Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ø£Ø¹Ø§Ø¯Ù†Ø§ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø²Ø± Ø¢Ø®Ø±ØŒ 
                // ÙˆÙ„ÙƒÙ† Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª ØªØµÙÙŠØ±Ù‡ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù† Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ:
                selectedExamIds.clear(); 
                
                snap.forEach(doc => {
                    allExamsCache.push({ id: doc.id, ...doc.data() });
                });
                
                // Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹
                renderMergeList(allExamsCache);
                updateSelectedCount();
            });
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© (Ù…ØµÙØ§Ø© Ø£Ùˆ ÙƒØ§Ù…Ù„Ø©)
        function renderMergeList(exams) {
            const list = document.getElementById('merge-source-list');
            list.innerHTML = '';
            
            if(exams.length === 0) {
                list.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</div>';
                return;
            }

            exams.forEach(e => {
                const gradeBadge = `<small style="background:#e0f2fe; color:#0369a1; padding:2px 6px; border-radius:4px; display:inline-block; margin-right:5px;">${gradeNames[e.grade] || e.grade}</small>`;
                const isChecked = selectedExamIds.has(e.id) ? 'checked' : ''; // ÙØ­Øµ Ù‡Ù„ Ù‡Ùˆ Ù…Ø­Ø¯Ø¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹

                list.innerHTML += `
                    <label class="check-exam-box">
                        <input type="checkbox" class="merge-check-input" value="${e.id}" ${isChecked} onchange="toggleExamSelection('${e.id}', this)">
                        <div style="flex:1;">
                            <div style="font-weight:600; color:#334155;">${e.title}</div>
                            <div style="display:flex; gap:5px; margin-top:2px;">
                                ${gradeBadge}
                                <small style="color:#64748b;">${e.category}</small>
                            </div>
                        </div>
                    </label>
                `;
            });
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØµÙÙŠØ© (Ø§Ù„Ø¨Ø­Ø«)
        function filterMergeList() {
            const term = document.getElementById('exam-search-input').value.toLowerCase();
            const filtered = allExamsCache.filter(e => 
                e.title.toLowerCase().includes(term) || 
                (gradeNames[e.grade] && gradeNames[e.grade].includes(term)) ||
                e.category.includes(term)
            );
            renderMergeList(filtered);
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù…ØªØ­Ø§Ù† (ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø°Ø§ÙƒØ±Ø© selectedExamIds)
        function toggleExamSelection(id, checkbox) {
            if (checkbox.checked) {
                selectedExamIds.add(id);
            } else {
                selectedExamIds.delete(id);
            }
            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').innerText = selectedExamIds.size;
        }

        // ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± **Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ø­Ø§Ù„ÙŠØ§Ù‹** ÙÙ‚Ø·
        function selectAllVisible() {
            const visibleInputs = document.querySelectorAll('.merge-check-input');
            visibleInputs.forEach(input => {
                if(!input.checked) {
                    input.checked = true;
                    selectedExamIds.add(input.value);
                }
            });
            updateSelectedCount();
        }

        // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ (Ø³ÙˆØ§Ø¡ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ø£Ùˆ Ø§Ù„Ù…Ø®ÙÙŠ)
        function clearAllSelection() {
            selectedExamIds.clear();
            const inputs = document.querySelectorAll('.merge-check-input');
            inputs.forEach(i => i.checked = false);
            updateSelectedCount();
        }

        async function mergeExams() {
            // Ù†Ø¹ØªÙ…Ø¯ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Set (selectedExamIds) ÙˆÙ„ÙŠØ³ Ø¹Ù„Ù‰ DOM ÙÙ‚Ø·
            const idsToMerge = Array.from(selectedExamIds);
            
            const newTitle = document.getElementById('merge-title').value;
            const newGrade = document.getElementById('merge-grade').value;
            const newCategory = document.getElementById('merge-category').value;

            if (idsToMerge.length === 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ø®ØªØ± Ø§Ù…ØªØ­Ø§Ù†Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¯Ù…Ø¬', 'warning');
            if (!newTitle) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯', 'warning');

            showLoader();
            try {
                // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const newExamRef = await db.collection('exams').add({ 
                    title: newTitle, 
                    grade: newGrade, 
                    subject: 'merged', 
                    category: newCategory, 
                    createdAt: new Date().toISOString() 
                });

                // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                let allQuestions = [];
                // Ù†Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¶ØºØ· Ø£Ùˆ ØªØ¬Ø§ÙˆØ² Ø­Ø¯ÙˆØ¯ Firebase Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹
                // (Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Promise.all Ø¨Ø¨Ø³Ø§Ø·Ø©)
                const fetchPromises = idsToMerge.map(eid => db.collection('questions').where('examId', '==', eid).get());
                const snapshots = await Promise.all(fetchPromises);
                
                snapshots.forEach(snap => { 
                    snap.forEach(doc => { allQuestions.push(doc.data()); }); 
                });

                if (allQuestions.length === 0) { 
                    hideLoader(); 
                    return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙØ§Ø±ØºØ© Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø©!', 'info'); 
                }

                // 3. Ù†Ø³Ø® Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Batch Write - Limit 500 per batch)
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¹Ø¯Ø¯ ÙƒØ¨ÙŠØ± Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨ØªÙ‚Ø³ÙŠÙ…Ù‡Ø§ Ø¥Ù„Ù‰ Ø¯ÙØ¹Ø§Øª
                const batchSize = 450; // Ø£Ù‚Ù„ Ù…Ù† 500 Ù„Ù„Ø£Ù…Ø§Ù†
                const chunks = [];
                for (let i = 0; i < allQuestions.length; i += batchSize) {
                    chunks.push(allQuestions.slice(i, i + batchSize));
                }

                let totalCopied = 0;
                for (const chunk of chunks) {
                    const batch = db.batch();
                    chunk.forEach(qData => {
                        const newQRef = db.collection('questions').doc();
                        batch.set(newQRef, { q: qData.q, c: qData.c, w: qData.w, examId: newExamRef.id });
                        totalCopied++;
                    });
                    await batch.commit();
                }

                hideLoader(); 
                Swal.fire('ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', `ØªÙ… Ø§Ù„Ø¯Ù…Ø¬ ÙˆÙ†Ø³Ø® ${totalCopied} Ø³Ø¤Ø§Ù„.`, 'success');
                
                // ØªÙ†Ø¸ÙŠÙ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
                loadExamsList(); 
                document.getElementById('merge-title').value = ''; 
                document.getElementById('exam-search-input').value = '';
                selectedExamIds.clear(); // ØªØµÙÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ¯Ø§Øª
                loadExamsForMergeList(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                
            } catch (error) { 
                hideLoader(); 
                console.error(error);
                Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯Ù…Ø¬: ' + error.message, 'error'); 
            }
        }

        // --- 2. Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ---
        function loadExamsToSelect(){
            const sel = document.getElementById('target-exam-select');
            sel.innerHTML = '<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>';
            db.collection('exams').orderBy('createdAt','desc').get().then(snap=>{
                sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† --</option>';
                snap.forEach(doc=>{ const e = doc.data(); const opt = document.createElement('option'); opt.value = doc.id; opt.innerText = `${e.title} (${gradeNames[e.grade]})`; sel.appendChild(opt); });
            });
        }
        function loadExamQuestionsCount(){
            const id = document.getElementById('target-exam-select').value; if(!id) return;
            db.collection('questions').where('examId','==',id).get().then(snap=>{ document.getElementById('exam-q-info').innerText = `Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${snap.size}`; });
        }
        function addQuestionToExam(){
            const examId = document.getElementById('target-exam-select').value; if(!examId) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†','warning');
            db.collection('questions').add({ examId: examId, q: document.getElementById('q-text').value, c: document.getElementById('q-c').value, w: [document.getElementById('q-w1').value, document.getElementById('q-w2').value, "Ø®Ø·Ø£"] }).then(()=>{ Swal.fire('ØªÙ…','','success'); document.getElementById('q-text').value=''; loadExamQuestionsCount(); });
        }
        function addBulkQuestions(){
            const examId = document.getElementById('target-exam-select').value; if(!examId) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†','warning');
            try { const data = JSON.parse(document.getElementById('in-bulk').value); const batch = db.batch(); data.forEach(item => { const ref = db.collection('questions').doc(); batch.set(ref, { ...item, examId: examId }); }); batch.commit().then(()=>{ Swal.fire('ØªÙ… Ø§Ù„Ø±ÙØ¹','','success'); loadExamQuestionsCount(); }); } catch(e) { Swal.fire('Ø®Ø·Ø£ JSON','','error'); }
        }

        // --- 3 & 4. Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ ---
        function saveLesson() { db.collection("lessons").add({ grade: document.getElementById('in-l-grade').value, title: document.getElementById('in-l-tit').value, body: document.getElementById('in-l-bod').value, img: document.getElementById('in-l-img').value }).then(() => Swal.fire('ØªÙ… Ø§Ù„Ù†Ø´Ø±', '', 'success')).catch(e => alert("Ø®Ø·Ø£")); }
        function saveVideo() { db.collection("videos").add({ grade: document.getElementById('in-v-grade').value, title: document.getElementById('v-tit').value, url: document.getElementById('v-url').value }).then(() => Swal.fire('ØªÙ… Ø§Ù„Ù†Ø´Ø±', '', 'success')).catch(e => alert("Ø®Ø·Ø£")); }

        // --- 5. Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ---
        function loadExamsForPosts() {
            const sel = document.getElementById('post-exam-select'); sel.innerHTML = '<option value="">-- Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„... --</option>';
            db.collection('exams').orderBy('createdAt','desc').limit(20).get().then(snap => { sel.innerHTML = '<option value="">-- Ø¨Ø¯ÙˆÙ† Ø§Ù…ØªØ­Ø§Ù† --</option>'; snap.forEach(doc => { sel.innerHTML += `<option value="${doc.id}">${doc.data().title}</option>`; }); });
        }
        function createPost() {
            const title = document.getElementById('post-title').value; const body = document.getElementById('post-body').value; const img = document.getElementById('post-img').value; const examId = document.getElementById('post-exam-select').value; const grade = document.getElementById('post-grade').value;
            if(!title && !body) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ù†Øµ Ù…Ø·Ù„ÙˆØ¨', 'warning');
            db.collection('posts').add({ title, body, img, examId, grade, timestamp: new Date().toISOString() }).then(() => { Swal.fire('ØªÙ… Ø§Ù„Ù†Ø´Ø±', '', 'success'); loadPostsList(); document.getElementById('post-title').value = ''; document.getElementById('post-body').value = ''; });
        }
        function loadPostsList() {
            const div = document.getElementById('posts-list-manage'); div.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            db.collection('posts').orderBy('timestamp', 'desc').get().then(snap => {
                div.innerHTML = '';
                snap.forEach(doc => {
                    const p = doc.data();
                    div.innerHTML += `<div style="background:#fdf4ff; padding:10px; margin-bottom:5px; border:1px solid #f0abfc; display:flex; justify-content:space-between; border-radius:8px;"><div><b>${p.title}</b> <small>(${gradeNames[p.grade]})</small></div><button class="btn-del" onclick="db.collection('posts').doc('${doc.id}').delete().then(()=>loadPostsList())">Ø­Ø°Ù</button></div>`;
                });
            });
        }

        // --- 6. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ---
        function loadManageData(type, btn) {
            if(btn) { document.querySelectorAll('.manage-filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            const list = document.getElementById('mng-list'); list.innerHTML = '<p style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...</p>';
            let items = []; const promises = [];
            if(type === 'all' || type === 'questions') promises.push(db.collection("questions").get().then(s => s.forEach(d => items.push({id: d.id, ...d.data(), col:'questions', lbl:'Ø³Ø¤Ø§Ù„'}))));
            if(type === 'all' || type === 'lessons') promises.push(db.collection("lessons").get().then(s => s.forEach(d => items.push({id: d.id, ...d.data(), col:'lessons', lbl:'Ø¯Ø±Ø³'}))));
            if(type === 'all' || type === 'videos') promises.push(db.collection("videos").get().then(s => s.forEach(d => items.push({id: d.id, ...d.data(), col:'videos', lbl:'ÙÙŠØ¯ÙŠÙˆ'}))));
            Promise.all(promises).then(() => { list.innerHTML = items.length ? items.map(i => `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee; margin-bottom:5px;"><div><b>${(i.q || i.title || "").substring(0,40)}</b> <span style="font-size:12px; color:#888;">(${i.lbl})</span></div><div><button class="btn-edit" onclick="openEditModal('${i.id}','${i.col}','${i.grade}')"><i class="fas fa-pen"></i></button><button class="btn-del" onclick="delDoc('${i.col}','${i.id}')"><i class="fas fa-trash"></i></button></div></div>`).join('') : '<p style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰</p>'; });
        }
        function delDoc(c, id) { if(confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ")) { db.collection(c).doc(id).delete().then(() => loadManageData('all')); } }
        function openEditModal(id, c, g) { document.getElementById('edit-id').value = id; document.getElementById('edit-col').value = c; document.getElementById('edit-grade').value = g || 'all'; document.getElementById('modal-edit').style.display = 'flex'; }
        function saveEdit() { const id = document.getElementById('edit-id').value; const col = document.getElementById('edit-col').value; db.collection(col).doc(id).update({ grade: document.getElementById('edit-grade').value }).then(() => { document.getElementById('modal-edit').style.display = 'none'; Swal.fire('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', '', 'success'); loadManageData('all'); }); }

        // --- 7. Ø§Ù„Ø·Ù„Ø§Ø¨ ---
        function loadStudents(){
            const tb = document.getElementById('users-body'); tb.innerHTML = '<tr><td colspan="4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            db.collection('users').get().then(snap=>{
                tb.innerHTML = '';
                snap.forEach(d=>{
                    const u = d.data();
                    tb.innerHTML += `<tr><td>${u.name}</td> <td>${gradeNames[u.grade] || u.grade}</td> <td>${u.email}</td><td><button class="btn btn-sec" style="font-size:12px; padding:5px 10px; width:auto;" onclick="grantBadge('${d.id}')" title="Ù…Ù†Ø­ ÙˆØ³Ø§Ù…"><i class="fas fa-medal"></i></button><button class="btn btn-report" style="font-size:12px; padding:5px 10px; width:auto;" onclick="viewStudentReport('${d.id}', '${u.name}', '${u.grade}')" title="ØªÙ‚Ø±ÙŠØ±"><i class="fas fa-file-alt"></i></button><button class="btn btn-del" style="font-size:12px; padding:5px 10px; width:auto;" onclick="deleteStudent('${d.id}')" title="Ø­Ø°Ù"><i class="fas fa-user-slash"></i></button></td></tr>`;
                });
            });
        }
        function deleteStudent(uid) { Swal.fire({ title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ', text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ø­Ø°Ù', cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡' }).then((result) => { if (result.isConfirmed) { db.collection('users').doc(uid).delete().then(() => { Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù!', '', 'success'); loadStudents(); }); } }) }
        function viewStudentReport(uid, name, grade) {
            showLoader(); const reportArea = document.getElementById('report-content-area'); reportArea.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</p>'; document.getElementById('modal-student-report').style.display = 'flex';
            Promise.all([ db.collection("results").where("name", "==", name).get(), db.collection("user_badges").where("uid", "==", uid).get() ]).then((snapshots) => {
                const resultsSnap = snapshots[0]; const badgesSnap = snapshots[1];
                let totalExams = 0, totalScoreSum = 0, totalMaxScore = 0, historyHtml = '';
                resultsSnap.forEach(doc => { const r = doc.data(); totalExams++; totalScoreSum += Number(r.score); totalMaxScore += Number(r.total); const per = (r.score / r.total) * 100; historyHtml += `<tr><td>${r.examType}</td><td style="color:${per>=50?'green':'red'}">${r.score}/${r.total}</td><td>${per.toFixed(1)}%</td><td>${new Date(r.date).toLocaleDateString()}</td></tr>`; });
                let avgPercent = totalMaxScore > 0 ? (totalScoreSum / totalMaxScore) * 100 : 0;
                let levelText = avgPercent >= 90 ? "Ù…Ù…ØªØ§Ø² ğŸŒŸ" : avgPercent >= 75 ? "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ ğŸ‘" : avgPercent >= 50 ? "Ù…ØªÙˆØ³Ø· ğŸ‘Œ" : "ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† âš ï¸";
                reportArea.innerHTML = `<div class="report-header"><h3>${name}</h3><span>${gradeNames[grade]||grade}</span></div> <div class="report-stats"><div class="stat-box"><h4>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</h4><p>${levelText}</p></div> <div class="stat-box"><h4>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h4><p>${totalExams}</p></div> <div class="stat-box"><h4>Ø§Ù„Ø£ÙˆØ³Ù…Ø©</h4><p>${badgesSnap.size}</p></div></div> <h4>Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª:</h4> <div class="table-container"><table><thead><tr><th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>%</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody>${historyHtml||'<tr><td colspan=4>Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}</tbody></table></div>`; hideLoader();
            });
        }
        async function grantBadge(uid){ const {value:t} = await Swal.fire({input:'text', inputLabel:'Ø§Ø³Ù… Ø§Ù„ÙˆØ³Ø§Ù…'}); if(t) db.collection('user_badges').add({ uid, title:t, icon:'fas fa-medal', color:'gold', timestamp:new Date().toISOString() }).then(()=>Swal.fire('ØªÙ…')); }
        function createRule(){ const t=document.getElementById('badge-title').value; const i=document.getElementById('badge-icon').value; const c=document.getElementById('badge-cond').value; const th=Number(document.getElementById('badge-thresh').value); db.collection('badges_rules').add({title:t, icon:i, condition:c, threshold:th, type:'auto', color:'gold'}).then(()=>{ Swal.fire('ØªÙ…'); loadBadgeRules(); }); }
        function loadBadgeRules(){ const l=document.getElementById('rules-list'); l.innerHTML=''; db.collection('badges_rules').get().then(s=>{ s.forEach(d=>{ l.innerHTML+=`<div>${d.data().title} <button class="btn-del" onclick="db.collection('badges_rules').doc('${d.id}').delete().then(()=>loadBadgeRules())">x</button></div>`; }); }); }
        function loadStudentResults() { const tbody = document.getElementById('results-body'); tbody.innerHTML = '<tr><td colspan="6">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>'; db.collection("results").get().then(snap => { let docs = []; snap.forEach(d => docs.push({id: d.id, ...d.data()})); docs.sort((a,b) => new Date(b.date) - new Date(a.date)); tbody.innerHTML = docs.map(r => `<tr><td>${new Date(r.date).toLocaleDateString('ar-EG')}</td><td>${r.name}</td><td>${gradeNames[r.grade]||r.grade}</td><td>${r.examType}</td><td style="color:${(r.score/r.total)>=0.7?'green':'red'}">${r.score}/${r.total}</td><td><button class="btn-small-danger" onclick="delRes('${r.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join('') || '<tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>'; }); }
        function delRes(id) { if(confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†ØªÙŠØ¬Ø©ØŸ")) db.collection("results").doc(id).delete().then(() => loadStudentResults()); }
        function clearResults() { if(confirm("Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) { db.collection("results").get().then(snap => { const batch = db.batch(); snap.forEach(d => batch.delete(d.ref)); batch.commit().then(() => loadStudentResults()); }); } }

        // --- 10. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
        function loadSettings() { 
            db.collection("settings").doc("site_info").get().then(s => { 
                if(s.exists) { 
                    const d = s.data(); 
                    document.getElementById('set-title').value = d.title || ""; 
                    document.getElementById('set-logo').value = d.logo || ""; 
                    document.getElementById('set-desc').value = d.description || "";
                    document.getElementById('set-app-url').value = d.appUrl || ""; 
                    document.getElementById('set-wa').value = d.wa || ""; 
                    document.getElementById('set-tele').value = d.tele || ""; 
                    document.getElementById('set-face').value = d.face || ""; 
                    document.getElementById('set-tiktok').value = d.tiktok || "";

                    // ØªØ­Ù…ÙŠÙ„ ØªØ³Ù…ÙŠØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                    document.getElementById('lbl-grammar').value = d.labelGrammar || "";
                    document.getElementById('lbl-vocab').value = d.labelVocab || "";
                    document.getElementById('lbl-lib').value = d.labelLib || "";
                    document.getElementById('lbl-vid').value = d.labelVid || "";
                    document.getElementById('lbl-posts').value = d.labelPosts || "";
                } 
            }); 
        }
        function saveSiteSettings() { 
            let wa = document.getElementById('set-wa').value; 
            if(wa && !wa.startsWith('http')) wa = `https://wa.me/20${wa.replace(/^0+/,'')}`; 
            db.collection("settings").doc("site_info").set({ 
                title: document.getElementById('set-title').value, 
                logo: document.getElementById('set-logo').value, 
                description: document.getElementById('set-desc').value,
                appUrl: document.getElementById('set-app-url').value,
                wa: wa, 
                tele: document.getElementById('set-tele').value, 
                face: document.getElementById('set-face').value, 
                tiktok: document.getElementById('set-tiktok').value,
                // Ø­ÙØ¸ Ø§Ù„ØªØ³Ù…ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                labelGrammar: document.getElementById('lbl-grammar').value,
                labelVocab: document.getElementById('lbl-vocab').value,
                labelLib: document.getElementById('lbl-lib').value,
                labelVid: document.getElementById('lbl-vid').value,
                labelPosts: document.getElementById('lbl-posts').value
            }, {merge: true}).then(() => Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸', '', 'success')); 
        }
    </script>

</body></html>